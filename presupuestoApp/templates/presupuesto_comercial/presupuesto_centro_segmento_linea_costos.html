<div class="bloque-vista">
    <h2>ðŸ“Š ProyecciÃ³n presupuesto centro operacion-segmento Costos</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">ðŸ”„ Cargar desde histÃ³rico</button>
    </div>

    <table id="presupuestoTableCentroOperacionSegmentoCostos" class="display" style="width:100%">
        <thead>
            <tr>
                <th>AÃ±o</th>
                <th>Segmento</th>
                <th>Centro de operacion</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total AÃ±o</th>
                <th>VariaciÃ³n Valor</th>
                <th>VariaciÃ³n %</th>
        </thead>
         <tbody></tbody>
    </table>
</div>

<style>
    .fila-r2 {
        background-color: #f0f0f0;
        font-weight: bold;
    }
</style>


<script>
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
        return data;
    }

    // ðŸ”„ Pivotar datos y separar fila R2 por centro y segmento
    function pivoData(data, selectedCentro=null, selectedSegmento=null) { 
        let pivot = {};
        let meses = { 1:"Ene",2:"Feb",3:"Mar",4:"Abr",5:"May",6:"Jun",7:"Jul",8:"Ago",9:"Sep",10:"Oct",11:"Nov",12:"Dic" };

        data.forEach(row => {
            let key = row.year + '_' + row.nombre_centro_de_operacion + '_' + row.nombre_clase_cliente + '_' + row.nombre_linea_n1;
            if (!pivot[key]) {
                pivot[key] = { 
                    year: row.year, 
                    nombre_linea_n1: row.nombre_linea_n1,
                    nombre_centro_de_operacion: row.nombre_centro_de_operacion, 
                    nombre_clase_cliente: row.nombre_clase_cliente,
                    total_year: row.total_year, 
                };
            } 
            pivot[key][meses[row.mes]] = row.suma; 
        });
        let result = Object.values(pivot);

        return result;
    }

    $(function () {
        let table = null;
        let allData = []; // almacenar todos los datos cargados

        function loadTable(data) {
            allData = data; // almacenar todos los datos cargados
            let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            let columns = [{ data: 'year', title: 'AÃ±o' },
                        { data: 'nombre_clase_cliente', title: 'Segmento' },
                        { data: 'nombre_centro_de_operacion', title: 'Centro de operacion' }];
            meses.forEach(m => 
                columns.push({ data: m, title: m, render: numberFormat, className: "editable" }));
            
            // âž• columnas extra
            columns.push({ data: "total_year", title: "Total AÃ±o", render: numberFormat });
    
            if (table) {
                table.destroy();
                $('#presupuestoTableCentroOperacionSegmentoCostos').empty();
                $(".dt-buttons").remove();           // ðŸ”¹ elimina los botones Excel previos 
            }

            table = $('#presupuestoTableCentroOperacionSegmentoCostos').DataTable({
                data: pivoData(data),
                columns: columns,
                scrollX: true,
                scrollY: "300px",
                scrollCollapse: true,
                fixedHeader: true,
                dom: 'Bltip',
                buttons:[{ extend:'excelHtml5', text:'ðŸ“¥ Exportar a Excel', title:'Presupuesto Centro OperaciÃ³n Segmento Costos'}],
                
                columnDefs: [
                    {
                        targets: 0,
                        type: "string",
                        render: function (data, type, row) {
                            if (type === 'sort') return data === "R2" ? "ZZZ" : data;
                            return data;
                        }
                    }
                ],
                order: [[0, "asc"], [1, "asc"], [2, "asc"]]
            });

            // Mover botÃ³n Excel
            let wrapper = $(table.table().container());
            wrapper.find('.dt-buttons').detach().appendTo('.bloque-vista .btn-group');

            // Filtros tipo Excel
            table.columns().every(function (index) {
                if (index === 0 || index === 1 || index === 2) {   // ðŸ”¹ 0 = AÃ±o, 1 = segmento, 2 = Centro de operaciÃ³n
                    let column = this;
                    // id dinamico
                    let filtroId = index === 0 ? "aÃ±o" : (index === 1 ? "segmento" : "centro");

                    // BotÃ³n en el header
                    let button = $(`<button id="excel-filter-btn-${filtroId}" class="excel-filter-btn">
                                        ${index === 0 ? "AÃ±o â¬‡" : (index === 1 ? "Segmento â¬‡" : "Centro â¬‡")}
                                    </button>`).appendTo($(column.header()).empty());

                    // Contenedor del menÃº
                    let menu = $(`<div id="excel-filter-${filtroId}" class="excel-filter"></div>`).appendTo("body");

                    // Input de bÃºsqueda
                    let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                    // Lista de checkboxes
                    let list = $("<div></div>").appendTo(menu);

                    // Agregar opciones Ãºnicas como checkboxes
                    column.data().unique().sort().each(function (d) {
                        if (d) {
                            list.append(`<label><input type="checkbox" value="${d}" checked> ${d}</label><br/>`);
                        }
                    });

                    // FunciÃ³n aplicar filtro
                    function applyFilter() {
                        let selected = [];
                        menu.find("input[type='checkbox']:checked").each(function () {
                            selected.push("^" + $.fn.dataTable.util.escapeRegex($(this).val()) + "$");
                        });
                        column.search(selected.length ? selected.join("|") : "", true, false).draw();
                    }

                    // Evento checkbox
                    list.on("change", "input[type='checkbox']", applyFilter);

                    // Evento bÃºsqueda dentro del menÃº
                    searchBox.on("keyup", function () {
                        let val = $(this).val().toLowerCase();
                        list.find("label").each(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });

                    // Mostrar este menÃº y ocultar los demÃ¡s
                    button.on("click", function (e) {
                        e.stopPropagation();

                        // ðŸ”¹ Ocultar otros menÃºs antes de abrir este
                        $(".excel-filter").not(menu).hide();

                        // Posicionar y mostrar este
                        let offset = $(this).offset();
                        menu.css({
                            top: offset.top + $(this).outerHeight(),
                            left: offset.left,
                            width: $(this).outerWidth()
                        }).toggle();
                    });

                    // Cerrar menÃº al hacer clic fuera
                    $(document).on("click", function (e) {
                        if (!$(e.target).closest(`#excel-filter-${filtroId}, button`).length) {
                            menu.hide();
                        }
                    });
                }
            });

            // Guardar al hacer clic fuera
            $(document).on('click', function(e) {
                if (editingCell) {
                    let $cell = $(editingCell);
                    let $input = $cell.find('input');
                    if ($input.length && !$(e.target).closest('#presupuestoTableCentroOperacionSegmentoCostos').length) {
                        let cell = table.cell(editingCell);
                        cell.data($input.val()).draw(false);
                        editingCell = null;
                    }
                }
            });
        }

        // ðŸ”„ Cargar histÃ³rico desde el backend
        $('#cargarBtn').on('click', function() {
            let boton = $(this);
            boton.prop('disabled', true).append('<span class="spinner"></span>');

            $.ajax({
                url: "{% url 'cargarCentroSegmentoLineaCostos' %}",
                method: "GET",
                dataType: "json",
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    console.log("Datos cargados:", datos);
                    loadTable(datos);
                },
                error: function(err) {
                    alert("Error al cargar datos: " + (err.responseJSON?.mensaje || err.statusText));
                },
                complete: function() {
                    boton.prop('disabled', false).find('.spinner').remove();
                }
            });

        });


        
    });

</script>
{% extends "presupuesto_comercial/base_presupuesto_comercial.html" %}
{% load static %}

{% block css %}
<style>
    table.dataTable thead th {
      background-color: #007bff;
      color: white;
    }
    .excel-filter {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        width: 150px !important;   /* ajusta a lo que necesites */
        min-width: 80px;          /* opcional */
    }
    .excel-filter input[type="text"] {
        width: 95%;
        margin-bottom: 6px;
        padding: 3px;
    }
    .excel-filter-btn {
        width: 100%;
        padding: 4px 6px;
        background: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        text-align: left;
    }
</style>
{% endblock %}

{% block content %}
<div class="bloque-vista">
    <h2>üìä Proyecci√≥n presupuesto centro operacion-linea-segmento Costos</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">üîÑ Cargar desde hist√≥rico</button>
    </div>

    <table id="presupuestoTableCentroOperacionSegmentoLineaCostos" class="display" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Linea</th>
                <th>Segmento</th>
                <th>Centro de operacion</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total A√±o</th>
        </thead>
         <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block js %}
<script>
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
        return data;
    }

    // üîÑ Pivotar datos y separar fila R2 por centro y segmento
    function pivoData(data, selectedCentro=null, selectedSegmento=null) { 
        let pivot = {};
        let meses = { 1:"Ene",2:"Feb",3:"Mar",4:"Abr",5:"May",6:"Jun",7:"Jul",8:"Ago",9:"Sep",10:"Oct",11:"Nov",12:"Dic" };

        data.forEach(row => {
            let key = row.year + '_' + row.linea + '_' + row.nombre_centro_operacion + '_' + row.segmento;
            if (!pivot[key]) {
                pivot[key] = { 
                    year: row.year, 
                    linea: row.linea,
                    nombre_centro_operacion: row.nombre_centro_operacion, 
                    segmento: row.segmento,
                    total_year: row.total_year || 0, 
                };
                // üëâ Inicializar TODOS los meses en 0
                Object.values(meses).forEach(m => pivot[key][m] = 0);
            } 
            let month = parseInt(row.mes);
            pivot[key][meses[month]] = row.total;

        });
        let result = Object.values(pivot);
        return result;
    }

    $(function () {
        let table = null;

        function loadTable(data) {
            if ($.fn.DataTable.isDataTable('#presupuestoTableCentroOperacionSegmentoLineaCostos')) {
                $('#presupuestoTableCentroOperacionSegmentoLineaCostos').DataTable().clear().destroy();
                $('#presupuestoTableCentroOperacionSegmentoLineaCostos').empty();  // üî• IMPORTANTE: limpiar thead/tbody
            }
            let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            let columns = [{ data: 'year', title: 'A√±o' },
                        { data: 'linea', title: 'Linea' },
                        { data: 'segmento', title: 'Segmento' },
                        { data: 'nombre_centro_operacion', title: 'Centro de operacion' }];
            meses.forEach(m => 
                columns.push({ data: m, title: m, render: numberFormat, className: "editable" }));
            
            // ‚ûï columnas extra
            columns.push({ data: "total_year", title: "Total A√±o", render: numberFormat });

            table = $('#presupuestoTableCentroOperacionSegmentoLineaCostos').DataTable({
                data: pivoData(data),
                columns: columns,
                scrollX: true,
                scrollCollapse: true,
                fixedHeader: true,
                dom: 'Bltip',
                buttons:[
                    { 
                        extend:'excelHtml5', 
                        text:'üì• Exportar a Excel', 
                        title:'Centro Operaci√≥n Segmento linea Costos',
                        exportOptions: {
                            format: {
                                body: function (data, row, column, node) {
                                    // ‚ùó Si el valor est√° renderizado con puntos o comas, eliminar formato
                                    if (typeof data === "string") {
                                        // Quitar puntos de miles y dejar coma decimal o viceversa
                                        return data.replace(/\./g, '').replace(/,/g, '.');
                                    }
                                    return data;
                                }
                            }
                        } 
                    }
                ],
                
                order: [[0, "asc"], [1, "asc"], [2, "asc"]]
            });

            // Mover bot√≥n Excel
            let wrapper = $(table.table().container());
            wrapper.find('.dt-buttons').detach().appendTo('.bloque-vista .btn-group');

            // Filtros tipo Excel
            table.columns().every(function (index) {
                if (index === 0 || index === 1 || index === 2) {   // üîπ 0 = A√±o, 1 = segmento, 2 = Centro de operaci√≥n
                    let column = this;
                    // id dinamico
                    let filtroId = index === 0 ? "a√±o" : (index === 1 ? "segmento" : "centro");

                    // Bot√≥n en el header
                    let button = $(`<button id="excel-filter-btn-${filtroId}" class="excel-filter-btn">
                                        ${index === 0 ? "A√±o ‚¨á" : (index === 1 ? "Segmento ‚¨á" : "Centro ‚¨á")}
                                    </button>`).appendTo($(column.header()).empty());

                    // Contenedor del men√∫
                    let menu = $(`<div id="excel-filter-${filtroId}" class="excel-filter"></div>`).appendTo("body");

                    // Input de b√∫squeda
                    let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                    // Lista de checkboxes
                    let list = $("<div></div>").appendTo(menu);

                    // Agregar opciones √∫nicas como checkboxes
                    column.data().unique().sort().each(function (d) {
                        if (d) {
                            list.append(`<label><input type="checkbox" value="${d}" checked> ${d}</label><br/>`);
                        }
                    });

                    // Funci√≥n aplicar filtro
                    function applyFilter() {
                        let selected = [];
                        menu.find("input[type='checkbox']:checked").each(function () {
                            selected.push("^" + $.fn.dataTable.util.escapeRegex($(this).val()) + "$");
                        });
                        column.search(selected.length ? selected.join("|") : "", true, false).draw();
                    }

                    // Evento checkbox
                    list.on("change", "input[type='checkbox']", applyFilter);

                    // Evento b√∫squeda dentro del men√∫
                    searchBox.on("keyup", function () {
                        let val = $(this).val().toLowerCase();
                        list.find("label").each(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });

                    // Mostrar este men√∫ y ocultar los dem√°s
                    button.on("click", function (e) {
                        e.stopPropagation();

                        // üîπ Ocultar otros men√∫s antes de abrir este
                        $(".excel-filter").not(menu).hide();

                        // Posicionar y mostrar este
                        let offset = $(this).offset();
                        menu.css({
                            top: offset.top + $(this).outerHeight(),
                            left: offset.left,
                            width: $(this).outerWidth()
                        }).toggle();
                    });

                    // Cerrar men√∫ al hacer clic fuera
                    $(document).on("click", function (e) {
                        if (!$(e.target).closest(`#excel-filter-${filtroId}, button`).length) {
                            menu.hide();
                        }
                    });
                }
            });

        }

        // üîÑ Cargar hist√≥rico desde el backend
        $('#cargarBtn').on('click', function() {
            let boton = $(this);
            boton.prop('disabled', true).append('<span class="spinner"></span>');

            $.ajax({
                url: "{% url 'cargarCentroSegmentoLineaCostos' %}",
                method: "GET",
                dataType: "json",
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    console.log("üì• DATOS RECIBIDOS DEL BACKEND (primeros 5):");
                    console.log(JSON.stringify(datos.slice(0, 5), null, 2));

                    loadTable(datos);
                },
                error: function(err) {
                    alert("Error al cargar datos: " + (err.responseJSON?.mensaje || err.statusText));
                },
                complete: function() {
                    boton.prop('disabled', false).find('.spinner').remove();
                }
            });

        });

        // Cargar inicialmente la tabla con datos vac√≠os
        $.ajax({
            url:"{% url 'obtener_presupuesto_centro_segmento_linea_costos' %}",
            type:"GET",
            dataType:"json",
            success:function(resp){ let datos=Array.isArray(resp)?resp:resp.data; loadTable(datos); }
        });

    });

</script>
{% endblock %}
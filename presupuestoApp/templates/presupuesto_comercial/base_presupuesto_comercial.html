{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Presupuesto Comercial{% endblock %}</title>
  
  <!-- DataTables CSS (global) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- jQuery y DataTables JS (global) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- CSS de FixedHeader -->
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
  <!-- JS de FixedHeader -->
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  
  <!--custom css-->
  {% block css %}
  <style>
    td.editable { background: #f8f9fa; cursor: pointer; }
    button { margin: 5px; }
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }

    table.dataTable thead th {
      background-color: #007bff;
      color: white;
    }

    .dataTables_wrapper {
      max-width: 1500px;
      margin: auto;
    }
    .dt-right {
        text-align: right;
        padding-right: 10px;
    }

    .bloque-vista {
      border-radius: 8px;
      padding: 15px;
      margin: 15px auto;
      max-width: 100%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-cargar {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
      position: relative;
    }

    .btn-cargar:hover:not(:disabled) {
      background-color: #0056b3;
    }

    .btn-cargar:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    /* Spinner */
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .vista-cargada {
      position: relative;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 20px auto;
      transition: opacity 0.4s ease, transform 0.4s ease;
      display: block;       /* 🔹 que ocupe todo el ancho */
      width: fit-content;   /* 🔹 se ajusta al contenido */
      max-width: 100%;      /* 🔹 pero no sobrepasa la pantalla */
      overflow-x: auto;     /* 🔹 scroll horizontal si la tabla es muy ancha */
      }


    .vista-cargada.ocultando {
      opacity: 0;
      transform: scale(0.97);
    }

    .vista-cargada button.cerrar {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 18px;
      cursor: pointer;
    }

    .vista-cargada button.cerrar:hover {
      color: #d33;
    }
    
    /* Botones dentro del bloque-vista */
    .btn-accion {
        background-color: #28a745;  /* verde */
        color: white;
        padding: 8px 18px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s ease;
        margin-right: 10px;
    }

    .btn-accion:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-1px);
    }

    .btn-accion:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    /* Estilo especial para guardar */
    .btn-guardar {
        background-color: #28a745; /* amarillo */
        color: #ffffffff;
    }

    .btn-guardar:hover:not(:disabled) {
        background-color: #5abb70ff;
    }

    /* Spinner pequeño dentro de botones si quieres */
    .btn-accion .spinner {
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid #fff;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
        vertical-align: middle;
    }

    #presupuestoTableProyeccionGeneral th,
    #presupuestoTableProyeccionGeneral td {
        min-width: 80px;   /* ajusta según lo necesites */
        text-align: left; /* opcional, para alinear números */
    }

    /* Contenedor del menú */
    .excel-filter {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        width: 150px !important;   /* ajusta a lo que necesites */
        min-width: 80px;          /* opcional */
    }

    /* Título búsqueda */
    .excel-filter input[type="text"] {
        width: 100%;
        margin-bottom: 6px;
        padding: 3px;
    }

    .excel-filter-btn {
        width: 100%;
        padding: 4px 6px;
        background: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        text-align: left;
    }

    .excel-filter-btn:hover {
        background: #e0e0e0;
    }

  </style>
  {% endblock %}

</head>

<body class="light-mode">
   <h1 style="text-align: center;">PRESUPUESTO COMERCIAL</h1>
   <!-- Botones para cargar vistas -->
    <div style="text-align: center; margin: 20px;">
        <button id="btnVista1" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoGeneralVentas' %}', this)">
            <span class="btn-texto">Presupuesto general ventas</span>
            <span class="spinner" style="display: none;"></span>
        </button>
        <button id="btnVista2" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoCentroVentas' %}', this)">
            <span class="btn-texto">Presupuesto centro operacion ventas</span>
            <span class="spinner" style="display: none;"></span>
        </button>
        <button id="btnVista3" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoCentroSegmentoVentas' %}', this)">
            <span class="btn-texto">Presupuesto centro operacion-segmento ventas</span>
            <span class="spinner" style="display: none;"></span>
        </button>
        {% comment %} <button id="btnVista4" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoGeneralCostos' %}', this)">
            <span class="btn-texto">Presupuesto general costos</span>
            <span class="spinner" style="display: none;"></span>
        </button>
        <button id="btnVista5" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoCentroCostos' %}', this)">
            <span class="btn-texto">Presupuesto centro operacion costos</span>
            <span class="spinner" style="display: none;"></span>
        </button>
        <button id="btnVista6" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoCentroSegmentoCostos' %}', this)">
            <span class="btn-texto">Presupuesto centro operacion-segmento costos</span>
            <span class="spinner" style="display: none;"></span>
        </button> {% endcomment %}
        <button id="btnVista7" class="btn-cargar" onclick="cargarVista('{% url 'presupuestoComercial' %}', this)">
            <span class="btn-texto">Presupuesto comercial</span>
            <span class="spinner" style="display: none;"></span>
        </button>
    </div>

    <!-- Aquí se van cargando las vistas -->
    <div id="contenedor-vistas"></div>

<!--custom js-->
<script>
  function cargarVista(url, boton) {
    const contenedor = document.getElementById("contenedor-vistas");
    // 👉 Usa la URL como identificador único
    const idVista = btoa(url); // convierte la URL a base64 para que sea seguro como atributo
    
    // 👉 Verificar si ya existe la vista
    if (contenedor.querySelector(`[data-vista="${idVista}"]`)) {
      return;
    }

    // Guardar texto original solo una vez
    if (!boton.dataset.textoOriginal) {
      boton.dataset.textoOriginal = boton.querySelector(".btn-texto").textContent;
    }

    // Mostrar spinner y deshabilitar botón
    boton.disabled = true;
    boton.querySelector(".spinner").style.display = "inline-block";
    boton.querySelector(".btn-texto").textContent = "Cargando...";

    fetch(url)
      .then(response => response.text())
      .then(html => {
        // Crear un contenedor temporal
        const temp = document.createElement("div");
        temp.innerHTML = html;

        // Mover scripts manualmente
        temp.querySelectorAll("script").forEach(oldScript => {
          const newScript = document.createElement("script");
          if (oldScript.src) {
            newScript.src = oldScript.src;
          } else {
            newScript.textContent = oldScript.textContent;
          }
          document.body.appendChild(newScript);
        });

        // 👉 Crear un bloque individual para cada vista
        const bloque = document.createElement("div");
        bloque.classList.add("vista-cargada");
        bloque.setAttribute("data-vista", idVista); // 👉 identificador único

        // Botón de cerrar
        const btnCerrar = document.createElement("button");
        btnCerrar.textContent = "✖";
        btnCerrar.classList.add("cerrar");
        btnCerrar.title = "Cerrar vista";
        btnCerrar.onclick = () => {
          bloque.classList.add("ocultando");
          setTimeout(() => bloque.remove(), 300); // ⏳ Espera la animación
        };
        bloque.appendChild(btnCerrar);
        bloque.append(...temp.childNodes);

        

        // Insertar al final del contenedor (sin limpiar)
        contenedor.appendChild(bloque);
      })
      .catch(error => {
        console.error("Error al cargar la vista:", error);
        alert("Hubo un error al cargar la vista.");
      })
      .finally(() => {
         // Restaurar botón con su propio texto original
        boton.disabled = false;
        boton.querySelector(".spinner").style.display = "none";
        boton.querySelector(".btn-texto").textContent = boton.dataset.textoOriginal;
        
      });
  }
</script>

{% block js %}
{% endblock %}
  
</body>

</html>
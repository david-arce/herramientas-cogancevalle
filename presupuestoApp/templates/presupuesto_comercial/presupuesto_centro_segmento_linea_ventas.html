{% extends "presupuesto_comercial/base_presupuesto_comercial.html" %}
{% load static %}

{% block css %}
<style>
    table.dataTable thead th {
      background-color: #007bff;
      color: white;
    }
    .excel-filter {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        width: 150px !important;   /* ajusta a lo que necesites */
        min-width: 80px;          /* opcional */
    }
    .excel-filter input[type="text"] {
        width: 95%;
        margin-bottom: 6px;
        padding: 3px;
    }
    .excel-filter-btn {
        width: 100%;
        padding: 4px 6px;
        background: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        text-align: left;
    }
    .btn-actualizar {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    } 
</style>
{% endblock %}

{% block content %}
<div class="bloque-vista">
    <h2>üìä Proyecci√≥n presupuesto centro operacion-segmento-linea Ventas</h2>

    <div class="btn-group">
        {% comment %} <button type="button" id="cargarBtnCentroSegVentas" class="btn-accion">üîÑ Cargar desde hist√≥rico</button> {% endcomment %}
        {% comment %} <button type="button" id="guardarBtn" class="btn-accion btn-guardar">üíæ Guardar cambios</button> {% endcomment %}
        <button type="button" id="actualizarBtnCentroSegmento" class="btn-actualizar">Actualizar tabla <span class="spinner" style="display:none; margin-left:8px;"></span></button>
    </div>

    <table id="presupuestoTableCentroOperacionSegmentoLineaVentas" class="display" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Linea</th>
                <th>Segmento</th>
                <th>Centro de operacion</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total A√±o Ventas</th>
                <th>Total A√±o Costos</th>
                <th>Variaci√≥n Valor Ventas</th>
                <th>Variaci√≥n Ventas%</th>
                <th>Margen %</th>
                <th>Margen Valor </th>
                <th>Total proyectado</th>
        </thead>
         <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block js %}
<script>
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
        return data;
    }

    // üîÑ Pivotar datos y separar fila R2 por centro y segmento
    function pivoData(data, selectedCentro=null, selectedSegmento=null) { 
        console.log("Datos originales para pivotar:", data[0]);
        let pivot = {};
        let meses = { 1:"Ene",2:"Feb",3:"Mar",4:"Abr",5:"May",6:"Jun",7:"Jul",8:"Ago",9:"Sep",10:"Oct",11:"Nov",12:"Dic" };

        data.forEach(row => {
            let key = row.year + '_' + row.linea + '_' + row.nombre_centro_operacion + '_' + row.segmento;
            if (!pivot[key]) {
                pivot[key] = { 
                    year: row.year, 
                    linea: row.linea,
                    nombre_centro_operacion: row.nombre_centro_operacion, 
                    segmento: row.segmento,
                    total_year: row.total_year || 0, 
                    total_year_costos: row.total_year_costos || 0,
                    variacion_valor: row.variacion_valor || 0, 
                    variacion_pct: row.variacion_pct || 0,
                    utilidad_pct: row.utilidad_pct || 0,
                    utilidad_valor: row.utilidad_valor || 0,
                    total_proyectado: row.total_proyectado || 0
                };
                // üîπ Inicializa todos los meses con 0 o ""
                Object.values(meses).forEach(m => { pivot[key][m] = 0; });
            } 
            // üîπ Asigna el valor del mes real si existe
            if (meses[row.mes]) {
                pivot[key][meses[row.mes]] = row.total || 0;
            } 

        });
        let result = Object.values(pivot);
        
        // üîπ A√±o actual y siguiente din√°micos
        const a√±oActual = new Date().getFullYear();
        const a√±oSiguiente = a√±oActual + 1;

        // üîπ Agrupar por centro + segmento
        const agrupado = {};
        result.forEach(r => {
        const key = `${r.nombre_centro_operacion}_${r.segmento}_${r.linea}`;
            if (!agrupado[key]) agrupado[key] = [];
            agrupado[key].push(r);
        });

        let finalRows = [];

        Object.entries(agrupado).forEach(([key, filas]) => {
            // Ordenar por a√±o
            filas.sort((a, b) => a.year - b.year);
            filas.forEach(f => finalRows.push(f));

            const filaBase = filas.find(f => f.year === a√±oSiguiente);
            const [centro, segmento, linea] = key.split("_");

            if (filaBase) {
                // üî∏ Fila de utilidad %
                const filaPct = { 
                    year: "Margen % " + a√±oActual, 
                    nombre_centro_operacion: centro, 
                    segmento: segmento,
                    linea: linea
                };
                Object.keys(meses).forEach(num => {
                    const mes = meses[num];
                    const registroMes = data.find(r => 
                        r.year === a√±oSiguiente && 
                        r.mes === parseInt(num) &&
                        r.nombre_centro_operacion === centro &&
                        r.segmento === segmento &&
                        r.linea === linea
                    );
                    filaPct[mes] = registroMes ? registroMes.utilidad_pct : null;
                });
                filaPct.total_year = null;
                filaPct.total_year_costos = null;
                filaPct.variacion_valor = null;
                filaPct.variacion_pct = null;
                filaPct.utilidad_pct = filaBase.utilidad_pct;
                filaPct.utilidad_valor = null;
                filaPct.total_proyectado = null;

                // üî∏ Fila de utilidad valor
                const filaValor = { 
                    year: "Utilidad Valor " + a√±oSiguiente, 
                    nombre_centro_operacion: centro, 
                    segmento: segmento,
                    linea: linea
                };
                Object.keys(meses).forEach(num => {
                    const mes = meses[num];
                    const registroMes = data.find(r => 
                        r.year === a√±oSiguiente && 
                        r.mes === parseInt(num) &&
                        r.nombre_centro_operacion === centro &&
                        r.segmento === segmento &&
                        r.linea === linea
                    );
                    filaValor[mes] = registroMes ? registroMes.utilidad_valor : null;
                });
                // üî∏ Calcular total proyectado = suma de los valores mensuales
                const total_anual = Object.keys(meses)
                    .map(num => {
                        const mes = meses[num];
                        return filaValor[mes] ? Number(filaValor[mes]) : 0;
                    })
                    .reduce((a, b) => a + b, 0);

                // Asignar total anual
                filaValor.total_year = total_anual;
                filaValor.total_year_costos = null;
                filaValor.variacion_valor = null;
                filaValor.variacion_pct = null;
                filaValor.utilidad_pct = null;
                filaValor.utilidad_valor = filaBase.utilidad_valor;
                filaValor.total_proyectado = null;

                finalRows.push(filaPct, filaValor);
            }
        });

        return finalRows;
    }

    $(document).ready(function() {
        // boton actualizar 
        document.getElementById("actualizarBtnCentroSegmento").addEventListener("click", function () {
            const boton = $(this);
            const spinner = boton.find(".spinner");
            boton.prop("disabled", true);
            spinner.show();
            // llamada AJAX para actualizar presupuesto general ventas
            $.ajax({
                url: "{% url 'actualizar_presupuesto_centro_segmento_linea_ventas' %}",
                type: "GET",
                dataType: "json",
                success: function(resp) {
                    if (resp.status === "ok") {
                        alert("Presupuesto centro segmento linea actualizado correctamente.");
                        // recargar tabla
                        $.ajax({
                            url: "{% url 'obtener_presupuesto_centro_segmento_linea_ventas' %}",
                            type: "GET",
                            dataType: "json",
                            success: function(resp) {
                                let datos = Array.isArray(resp) ? resp : resp.data;
                                loadTable(datos);
                                boton.prop("disabled", false);
                                spinner.hide();
                            }
                        });
                    } else {
                        alert("Error al actualizar el presupuesto general de ventas.");
                    }
                },
                error: function(err) {
                    console.error("Error AJAX:", err);
                    alert("Error al actualizar el presupuesto general de ventas.");
                }
            });
        });
        let table = null;

        function loadTable(data) {
            if ($.fn.DataTable.isDataTable('#presupuestoTableCentroOperacionSegmentoLineaVentas')) {
                $('#presupuestoTableCentroOperacionSegmentoLineaVentas').DataTable().clear().destroy();
                $('#presupuestoTableCentroOperacionSegmentoLineaVentas').empty();  // üî• IMPORTANTE: limpiar thead/tbody
            }
            let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            let columns = [{ data: 'year', title: 'A√±o' },
                        { data: 'linea', title: 'Linea' },
                        { data: 'segmento', title: 'Segmento' },
                        { data: 'nombre_centro_operacion', title: 'Centro de operacion' }];
            meses.forEach(m => 
                columns.push({ data: m, title: m, render: numberFormat, className: "editable" }));
            
            // ‚ûï columnas extra
            columns.push({ data: "variacion_valor", title: "Variaci√≥n Valor", render: numberFormat });
            columns.push({ data: "variacion_pct", title: "Variaci√≥n Ventas%", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
            columns.push({ data: "total_year", title: "Total A√±o Ventas", render: numberFormat });
            columns.push({ data: "total_year_costos", title: "Total A√±o Costos", render: numberFormat });
            columns.push({ data: "utilidad_pct", title: "Margen %", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
            columns.push({ data: "utilidad_valor", title: "Margen Valor", render: numberFormat });
            columns.push({ data: "total_proyectado", title: "Total proyectado", render: numberFormat });

            table = $('#presupuestoTableCentroOperacionSegmentoLineaVentas').DataTable({
                data: pivoData(data),
                columns: columns,
                scrollX: true,
                scrollY: "600px",
                scrollCollapse: true,
                
                dom: 'Bltip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'üì• Exportar a Excel',
                        title: 'Presupuesto centro segmento Ventas',
                        exportOptions: {
                        columns: ':visible',
                        format: {
                            body: function (data, row, column, node) {
                            // Helper: quitar etiquetas HTML y trim
                            function stripHtml(input) {
                                if (input === null || input === undefined) return '';
                                if (typeof input !== 'string') return input;
                                return input.replace(/<\/?[^>]+(>|$)/g, "").trim();
                            }

                            var txt = stripHtml(data);

                            // √çndices de tus columnas num√©ricas seg√∫n tu DataTable (0-based)
                            var moneyCols = [3,4,5,6,7,8,9,10,11,12,13,14,15,17,19,21];
                            var percentCols = [16,18,20];

                            // Si es columna de dinero: quitar separadores de miles, s√≠mbolo y ajustar decimal
                            if (moneyCols.indexOf(column) !== -1) {
                                txt = String(txt)
                                        .replace(/\s/g,'')    // quita espacios
                                        .replace(/\$/g,'')    // quita signo peso (si lo hubiera)
                                        .replace(/\./g,'')    // quita separador de miles
                                        .replace(/,/g,'.')    // cambia coma decimal por punto
                                        .replace(/[^0-9.-]/g,''); // deja s√≥lo n√∫meros, punto y signo
                                return txt === '' ? 0 : txt;
                            }

                            // Si es columna de porcentaje: quitar % y normalizar decimal
                            if (percentCols.indexOf(column) !== -1) {
                                txt = String(txt)
                                        .replace(/\s/g,'')
                                        .replace(/%/g,'')
                                        .replace(/\./g,'')
                                        .replace(/,/g,'.')
                                        .replace(/[^0-9.-]/g,'');
                                return txt === '' ? 0 : txt;
                            }

                            // Columnas de texto: devolver el texto limpio (sin HTML)
                            return txt;
                            }
                        }
                        }
                    }
                ],
                order: [[0, "asc"], [1, "asc"], [2, "asc"]]
            });

            // Filtros tipo Excel
            table.columns().every(function (index) {

                // Columnas a filtrar: 0 = A√±o, 1 = L√≠nea, 2 = Segmento, 3 = Centro
                if (![0, 1, 2, 3].includes(index)) return;

                let column = this;

                // Diccionario para nombres
                const headers = {
                    0: "A√±o",
                    1: "L√≠nea",
                    2: "Segmento",
                    3: "Centro"
                };

                const filtroId = "filtro_" + index;

                // Crear bot√≥n dentro del header
                let button = $(`
                    <button id="excel-filter-btn-${filtroId}" class="excel-filter-btn">
                        ${headers[index]} ‚¨á
                    </button>
                `).appendTo($(column.header()).empty());

                // Crear men√∫ flotante
                let menu = $(`<div id="excel-filter-${filtroId}" class="excel-filter"></div>`).appendTo("body");

                let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                let list = $("<div></div>").appendTo(menu);

                // Opci√≥n seleccionar todo
                list.prepend(`
                    <label><input type="checkbox" class="select-all" checked> (Seleccionar todo)</label><br/>
                `);

                // Agregar valores √∫nicos como checkboxes
                let uniqueValues = column.data().unique().sort();
                uniqueValues.each(function (value) {
                    if (value !== undefined && value !== null && value !== "") {
                        list.append(`
                            <label><input type="checkbox" value="${value}" checked> ${value}</label><br/>
                        `);
                    }
                });

                // Funci√≥n que aplica el filtro
                function applyFilter() {
                    let selected = [];

                    list.find("input[type='checkbox']:checked").not(".select-all").each(function () {
                        selected.push("^" + $.fn.dataTable.util.escapeRegex($(this).val()) + "$");
                    });

                    column.search(selected.length ? selected.join("|") : "", true, false).draw();
                }

                // Seleccionar todo
                menu.find(".select-all").on("change", function () {
                    const checked = $(this).is(":checked");
                    list.find("input[type='checkbox']").not(this).prop("checked", checked);
                    applyFilter();
                });

                // Click en cada checkbox individual
                list.on("change", "input[type='checkbox']:not(.select-all)", applyFilter);

                // Buscar dentro del men√∫
                searchBox.on("keyup", function () {
                    let val = $(this).val().toLowerCase();
                    list.find("label").each(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                    });
                });

                // Mostrar men√∫
                button.on("click", function (e) {
                    e.stopPropagation();

                    // Cerrar otros men√∫s
                    $(".excel-filter").not(menu).hide();

                    let offset = $(this).offset();
                    menu.css({
                        top: offset.top + $(this).outerHeight(),
                        left: offset.left,
                        width: $(this).outerWidth()
                    }).toggle();
                });

                // Cerrar al hacer click fuera
                $(document).on("click", function (e) {
                    if (!$(e.target).closest(`#excel-filter-${filtroId}, button`).length) {
                        menu.hide();
                    }
                });

            });


        }

        // Cargar historico
        $('#cargarBtnCentroSegVentas').on('click', function() {
            let boton = $(this);
            boton.prop('disabled', true).append('<span class="spinner"></span>');

            $.ajax({
                url: "{% url 'cargarCentroSegmentoLineaVentas' %}",
                method: "GET",
                dataType: "json",
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    console.log("Datos cargados:", datos);
                    loadTable(datos);
                },
                error: function(err) {
                    alert("Error al cargar datos: " + (err.responseJSON?.mensaje || err.statusText));
                },
                complete: function() {
                    boton.prop('disabled', false).find('.spinner').remove();
                }
            });
        });

        
        // Carga inicial
        $.ajax({
            url:"{% url 'obtener_presupuesto_centro_segmento_linea_ventas' %}",
            type:"GET",
            dataType:"json",
            success:function(resp){ 
                let datos=Array.isArray(resp)?resp:resp.data;
                console.log("Datos iniciales cargados:", datos[0]); 
                loadTable(datos); 
            }
        });
    });

</script>
{% endblock %}
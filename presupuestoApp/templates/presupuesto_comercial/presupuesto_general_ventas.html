<div class="bloque-vista">  
    <h2>üìä Proyecci√≥n presupuesto general - Ventas</h2>

    <div class="btn-group">
        {% comment %} <button type="button" id="cargarBtnGeneralVentas" class="btn-accion">üîÑ Cargar desde hist√≥rico</button> {% endcomment %}
        {% comment %} <button type="button" id="guardarBtn" class="btn-accion btn-guardar">üíæ Guardar cambios</button> {% endcomment %}
    </div>

    <!-- Tabla pivotada -->
    <table id="presupuestoTableProyeccionGeneral" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total A√±o Ventas</th>
                <th>Total A√±o Costos</th>
                <th>Variaci√≥n Valor Ventas</th>
                <th>Variaci√≥n Ventas %</th>
                <th>Margen %</th>
                <th>Margen Valor </th>
                <th>Total proyectado</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
function numberFormat(data, type, row) {
    if (type === 'display' && !isNaN(data)) {
        return new Intl.NumberFormat('es-ES').format(data);
    }
    return data;
}

// üîÑ Pivotar datos y separar fila R2
function pivotData(data) { 
    let pivot = {}; 
    let meses = { 1: "Ene", 2: "Feb", 3: "Mar", 4: "Abr", 5: "May", 6: "Jun", 7: "Jul", 8: "Ago", 9: "Sep", 10: "Oct", 11: "Nov", 12: "Dic" }; 
    data.forEach(row => { 
        if (!pivot[row.year]) {
            pivot[row.year] = { 
                year: row.year,
                total_year: row.total_year || 0,
                total_year_costos: row.total_year_costos || 0,
                variacion_valor: row.variacion_valor || 0,
                variacion_pct: row.variacion_pct || 0,
                utilidad_pct: row.utilidad_pct || 0,
                utilidad_valor: row.utilidad_valor || 0,
                total_proyectado: row.total_proyectado || 0
            };
        } 
        pivot[row.year][meses[row.mes]] = row.total; 
        {% comment %} if (!pivot["R2"]) {
            pivot["R2"] = { 
                year: "R2" ,
                total_year: 0,
                variacion_valor: 0,
                variacion_pct: 0
            };
        } 
        pivot["R2"][meses[row.mes]] = row.r2;  {% endcomment %}
    }); 
    return Object.values(pivot); 
}

function unpivotData(tableData) {
    let meses = { "Ene":1, "Feb":2, "Mar":3, "Abr":4, "May":5, "Jun":6, "Jul":7, "Ago":8, "Sep":9, "Oct":10, "Nov":11, "Dic":12 };
    let result = [];
    tableData.forEach(row => {
        {% comment %} if(row.year === "R2") return;  {% endcomment %}
        Object.keys(meses).forEach(m => {
            if(row[m] !== undefined){
                result.push({
                    year: parseInt(row.year),
                    mes: meses[m],
                    total: parseInt(row[m]),
                    r2: 0 // se recalcular√° en el backend
                });
            }
        });
    });
    return result;
}

$(function () {
    let table = null;

    function loadTable(data) {
        let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        let columns = [{ data: 'year', title: 'A√±o' }];
        meses.forEach(m => {
            columns.push({ data: m, title: m, render: numberFormat, className: "editable" });
        });
        // ‚ûï columnas extra
        columns.push({ data: "total_year", title: "Total A√±o Ventas", render: numberFormat });
        columns.push({ data: "total_year_costos", title: "Total A√±o Costos", render: numberFormat });
        columns.push({ data: "variacion_valor", title: "Variaci√≥n Valor Ventas", render: numberFormat });
        columns.push({ data: "variacion_pct", title: "Variaci√≥n Ventas%", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
        columns.push({ data: "utilidad_pct", title: "Margen %", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
        columns.push({ data: "utilidad_valor", title: "Margen Valor", render: numberFormat });
        columns.push({ data: "total_proyectado", title: "Total proyectado", render: numberFormat });

        if (table) {
            table.destroy();
            $('#presupuestoTableProyeccionGeneral').empty();
            $("#excel-filter-ventas").remove();  // üîπ elimina men√∫s anteriores
            $(".dt-buttons").remove();           // üîπ elimina los botones Excel previos
        }

        table = $('#presupuestoTableProyeccionGeneral').DataTable({
            data: pivotData(data),
            columns: columns,
            paging: false,
            scrollX: true,
            dom: 'Bltip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: 'üì• Exportar a Excel',
                    title: 'Presupuesto General Ventas',
                exportOptions: {
                columns: ':visible',
                format: {
                    body: function (data, row, column, node) {
                    // Helper: quitar etiquetas HTML y trim
                    function stripHtml(input) {
                        if (input === null || input === undefined) return '';
                        if (typeof input !== 'string') return input;
                        return input.replace(/<\/?[^>]+(>|$)/g, "").trim();
                    }

                    var txt = stripHtml(data);

                    // √çndices de tus columnas num√©ricas seg√∫n tu DataTable (0-based)
                    var moneyCols = [1,2,3,4,5,8,9,10,11,12,13,15,19,20];
                    var percentCols = [16,17,18];

                    // Si es columna de dinero: quitar separadores de miles, s√≠mbolo y ajustar decimal
                    if (moneyCols.indexOf(column) !== -1) {
                        txt = String(txt)
                                .replace(/\s/g,'')    // quita espacios
                                .replace(/\$/g,'')    // quita signo peso (si lo hubiera)
                                .replace(/\./g,'')    // quita separador de miles
                                .replace(/,/g,'.')    // cambia coma decimal por punto
                                .replace(/[^0-9.-]/g,''); // deja s√≥lo n√∫meros, punto y signo
                        return txt === '' ? 0 : txt;
                    }

                    // Si es columna de porcentaje: quitar % y normalizar decimal
                    if (percentCols.indexOf(column) !== -1) {
                        txt = String(txt)
                                .replace(/\s/g,'')
                                .replace(/%/g,'')
                                .replace(/\./g,'')
                                .replace(/,/g,'.')
                                .replace(/[^0-9.-]/g,'');
                        return txt === '' ? 0 : txt;
                    }

                    // Columnas de texto: devolver el texto limpio (sin HTML)
                    return txt;
                    }
                }
                }
                }
            ],
            {% comment %} rowCallback: function(row, data) {
                if (data.year === "R2") $(row).addClass("fila-r2");
            }, {% endcomment %}
            columnDefs: [
                {
                    targets: 0,
                    type: "string",
                    render: function (data, type, row) {
                        if (type === 'sort') return data === "R2" ? "ZZZ" : data;
                        return data;
                    }
                }
            ],
            order: [[0, "asc"]]
        });

        // Mover bot√≥n Excel
        {% comment %} let wrapper = $(table.table().container()); 
        wrapper.find(".dt-buttons").appendTo(wrapper.closest(".bloque-vista").find(".btn-group")); {% endcomment %}

        // Filtro en columna A√±o
        table.columns().every(function (index) {
            if (index === 0) {
                let column = this;

                // Bot√≥n en el header
                let button = $('<button id="excel-filter-btn-ventas" class="excel-filter-btn">A√±o ‚¨á</button>')
                    .appendTo($(column.header()).empty());

                // Contenedor del men√∫
                let menu = $('<div id="excel-filter-ventas" class="excel-filter"></div>').appendTo('body');

                // Input de b√∫squeda
                let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                // Seleccionar todo / deseleccionar todo
                let selectAllDiv = $('<div class="select-all-container"></div>').appendTo(menu);
                selectAllDiv.append('<label><input type="checkbox" id="selectAllYears" checked> <strong>Seleccionar todo</strong></label><br/>');

                // Lista de checkboxes
                let list = $('<div class="checkbox-list"></div>').appendTo(menu);

                // Agregar opciones √∫nicas como checkboxes
                column.data().unique().sort().each(function (d) {
                    if (d) {
                        list.append('<label><input type="checkbox" value="' + d + '" checked> ' + d + '</label><br/>');
                    }
                });

                // Funci√≥n aplicar filtro (si no hay seleccionados -> no mostrar filas)
                function applyFilter() {
                    let selected = [];
                    menu.find('.checkbox-list input[type="checkbox"]:checked').each(function () {
                        selected.push('^' + $.fn.dataTable.util.escapeRegex($(this).val()) + '$');
                    });

                    if (selected.length === 0) {
                        // Ning√∫n a√±o seleccionado -> forzar resultado vac√≠o
                        column.search('^$', true, false).draw();
                    } else {
                        column.search(selected.join('|'), true, false).draw();
                    }
                }

                // Evento seleccionar/deseleccionar todo (act√∫a sobre elementos visibles primero)
                menu.on('change', '#selectAllYears', function () {
                    let checked = $(this).is(':checked');
                    let visibleItems = list.find('label:visible input[type="checkbox"]');
                    if (visibleItems.length) visibleItems.prop('checked', checked);
                    else list.find('input[type="checkbox"]').prop('checked', checked);
                    applyFilter();
                });

                // Evento individual checkbox
                list.on('change', 'input[type="checkbox"]', function () {
                    let totalVisible = list.find('label:visible input[type="checkbox"]').length;
                    let checkedVisible = list.find('label:visible input[type="checkbox"]:checked').length;

                    if (totalVisible === 0) {
                        totalVisible = list.find('input[type="checkbox"]').length;
                        checkedVisible = list.find('input[type="checkbox"]:checked').length;
                    }

                    $('#selectAllYears').prop('checked', totalVisible === checkedVisible);
                    applyFilter();
                });

                // B√∫squeda dentro del men√∫ (oculta/ muestra checkboxes)
                searchBox.on('keyup', function () {
                    let val = $(this).val().toLowerCase();
                    list.find("label").each(function () {
                        $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                    });

                    // actualizar estado de "Seleccionar todo" seg√∫n elementos visibles
                    let totalVisible = list.find('label:visible input[type="checkbox"]').length;
                    let checkedVisible = list.find('label:visible input[type="checkbox"]:checked').length;
                    $('#selectAllYears').prop('checked', totalVisible > 0 && totalVisible === checkedVisible);
                });

                // Mostrar/ocultar men√∫ (posicionar)
                button.on('click', function (e) {
                    e.stopPropagation();
                    let offset = $(this).offset();
                    menu.css({
                        top: offset.top + $(this).outerHeight(),
                        left: offset.left,
                        width: $(this).outerWidth()
                    }).toggle();
                });

                // Cerrar men√∫ al hacer clic fuera (espec√≠fico para este bot√≥n/men√∫)
                $(document).on('click', function (e) {
                    if (!$(e.target).closest('#excel-filter-ventas, #excel-filter-btn-ventas').length) {
                        menu.hide();
                    }
                });
            }
        });

        // Edici√≥n doble clic solo 2025
        let editingCell = null;
        $('#presupuestoTableProyeccionGeneral').on('dblclick', 'td.editable', function () {
            if (editingCell) return;
            let cell = table.cell(this);
            let rowData = table.row(this).data();
            if (rowData.year !== 2026) return;

            let oldValue = cell.data() || "";
            $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
            let $input = $(this).find("input").focus();
            editingCell = this;
            $input[0].setSelectionRange(0, $input.val().length);

            $input.on("keydown", function(e) {
                if (e.key === "Enter") { cell.data($input.val()).draw(false); editingCell = null; }
                else if (e.key === "Escape") { cell.data(oldValue).draw(false); editingCell = null; }
            });
        });

        // Guardar al hacer clic fuera
        $(document).on("click", function(e) {
            if (editingCell) {
                let $cell = $(editingCell);
                let $input = $cell.find("input");
                if ($input.length && !$(e.target).closest("#presupuestoTableProyeccionGeneral").length) {
                    let cell = table.cell(editingCell);
                    cell.data($input.val()).draw(false);
                    editingCell = null;
                }
            }
        });
    }

    // üîÑ Cargar desde hist√≥rico
    $(document).on("click", "#cargarBtnGeneralVentas", function () {
        let boton = $(this);
        boton.prop("disabled", true).append('<span class="spinner"></span>');

        $.ajax({
            url: "{% url 'cargar_presupuesto_general_ventas' %}",
            type: "GET",
            dataType: "json", // <- importante
            success: function(resp) {
                // si el servidor devuelve {data: [...]}
                let datos = Array.isArray(resp) ? resp : resp.data;
                loadTable(datos);
            },
            error: function(err) {
                console.error("Error AJAX:", err);
            },
            complete: function() {
                boton.prop("disabled", false).find(".spinner").remove();
            }
        });
    });

    // üíæ Guardar cambios
    $(document).on("click", "#guardarBtn", function () {
        if (!table) return;
        let boton = $(this);
        boton.prop("disabled", true).append('<span class="spinner"></span>');
        let data = unpivotData(table.rows().data().toArray());

        $.ajax({
            url: "{% url 'guardar_presupuesto_general_ventas' %}",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function(resp) { 
                // si el servidor devuelve {data: [...]}
                let datos = Array.isArray(resp) ? resp : resp.data;
                loadTable(datos); 
            },
            complete: function() {
                boton.prop("disabled", false).find(".spinner").remove();
            }
        });
    });

    // Primera carga autom√°tica
    $.ajax({
        url: "{% url 'obtener_presupuesto_general_ventas' %}",
        type: "GET",
        dataType: "json",
        success: function(resp) {
            let datos = Array.isArray(resp) ? resp : resp.data;
            loadTable(datos);
        }
    });
});


</script>

<style>
.fila-r2 { background-color: #f4f4f4; font-weight: bold; }
.excel-filter {
    background: white;
    border: 1px solid #ccc;
    padding: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    position: absolute;
    display: none;
    z-index: 9999;
    max-height: 300px;
    overflow-y: auto;
}
.excel-filter input[type="text"] {
    width: 95%;
    margin-bottom: 6px;
    padding: 3px;
}
.select-all-container {
    border-bottom: 1px solid #ddd;
    padding-bottom: 4px;
    margin-bottom: 4px;
}

</style>

<div class="bloque-vista">
    <h2>üìä Proyecci√≥n presupuesto centro operacion-segmento Ventas</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">üîÑ Cargar desde hist√≥rico</button>
        <button type="button" id="guardarBtn" class="btn-accion btn-guardar">üíæ Guardar cambios</button>
    </div>

    <table id="presupuestoTableCentroOperacionSegmento" class="display" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Mes</th>
                <th>Segmento</th>
                <th>Centro de operacion</th>
                <th>Total</th>
                <th>R2 %</th>
            </tr>
            <tr class="filters"> <!-- Filtros arriba -->
                <th></th> <!-- select a√±o -->
                <th></th> <!-- select mes -->
                <th></th> <!-- select segmento -->
                <th></th> <!-- select centro de operacion -->
                <th><input type="text" placeholder="üîç Total" style="width:100%"></th>
                <th><input type="text" placeholder="üîç R2 %" style="width:100%"></th>
            </tr>
        </thead>
    </table>
</div>

<script>
function numberFormat(data, type, row) {
    if (type === 'display' && !isNaN(data)) {
        return new Intl.NumberFormat('es-ES').format(data);
    }
    return data;
}

$(function () {   // ‚ö° $(function() {}) == $(document).ready()
    let table = $('#presupuestoTableCentroOperacionSegmento').DataTable({
        ajax: {
            url: "{% url 'obtener_presupuesto_centro_segmento_ventas' %}",
            dataSrc: ""
        },
        columns: [
            { data: "year" },
            { data: "mes" },
            { data: "segmento" },
            { data: "centro_operacion" },
            { data: "total" },
            { data: "r2"}
        ],
        columnDefs: [
            { targets: [4,5], render: numberFormat },
            { targets: [4], className: "editable" }
        ],
        orderCellsTop: true,
        fixedHeader: true,
        dom: 'Bltip', // üëà mantiene el selector de filas y agrega botones
        buttons: [
            {
                extend: 'excelHtml5',
                text: 'üì• Exportar a Excel',
                title: 'Presupuesto General Ventas'
            }
        ]
    });
    // üü¢ Configurar filtros din√°micos
    table.on('init.dt', function () {
        // Mueve el bot√≥n de Excel al grupo de botones personalizado
        let wrapper = $(table.table().container()); 
        wrapper.find(".dt-buttons").appendTo(wrapper.closest(".bloque-vista").find(".btn-group"));

        let headerCells = $(table.table().header()).find("tr.filters th");
        table.columns().every(function (index) {
            let column = this;
            let headerCell = headerCells.eq(index);

            if (index === 0 || index === 1 || index === 2 || index === 3) {
                // üëâ A√±o y Mes con select
                let select = $('<select><option value="">Todos</option></select>')
                    .appendTo(headerCell.empty())
                    .on('change', function () {
                        let val = $.fn.dataTable.util.escapeRegex($(this).val());
                        column.search(val ? '^' + val + '$' : '', true, false).draw();
                    });

                // Llenar opciones √∫nicas
                column.data().unique().sort().each(function (d) {
                    if (d) {
                        select.append('<option value="' + d + '">' + d + '</option>');
                    }
                });
            } else {
                // üëâ Total y R2 con input texto
                $('<input type="text" placeholder="üîç" style="width:100%"/>')
                    .appendTo(headerCell.empty())
                    .on('keyup change clear', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
            }
        });
    });

    
    let editingCell = null;
    // Doble clic para editar SOLO si el a√±o es 2025
    $('#presupuestoTableCentroOperacionSegmento').on('dblclick', 'td.editable', function () {
        if (editingCell) return;

        let cell = table.cell(this);
        let rowData = table.row(this).data();  // obtiene toda la fila

        if (rowData.year !== 2025) {
            // üö´ Bloquear edici√≥n
            return;
        }

        let oldValue = cell.data();
        $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
        let $input = $(this).find("input").focus();
        editingCell = this;

        $input[0].setSelectionRange(0, $input.val().length);

        $input.on("keydown", function(e) {
            if (e.key === "Enter") {
                cell.data($input.val()).draw(false);
                editingCell = null;
            } else if (e.key === "Escape") {
                cell.data(oldValue).draw(false);
                editingCell = null;
            }
        });
    });

    // Guardar cuando haces clic fuera
    $(document).on("click", function(e) {
        if (editingCell) {
            let $cell = $(editingCell);
            let $input = $cell.find("input");
            if ($input.length && !$(e.target).closest("#presupuestoTableCentroOperacionSegmento").length) {
                let cell = table.cell(editingCell);
                cell.data($input.val()).draw(false);
                editingCell = null;
            }
        }
    });

    // üîÑ Bot√≥n cargar desde hist√≥rico
    $(document).on("click", "#cargarBtn", function () {
        $.ajax({
            url: "{% url 'cargar_presupuesto_centro_segmento_ventas' %}",
            type: "GET",
            success: function() {
                alert("Datos recalculados y cargados desde hist√≥rico ‚úÖ");
                table.ajax.reload();
            },
            error: function(xhr) {
                alert("Error al cargar desde hist√≥rico ‚ùå " + xhr.responseText);
            }
        });
    });

    // üíæ Bot√≥n guardar cambios
    $(document).on("click", "#guardarBtn", function () {
        let data = table.rows().data().toArray();

        $.ajax({
            url: "{% url 'guardar_presupuesto_centro_segmento_ventas' %}",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function() {
                alert("Cambios guardados ‚úÖ");
                table.ajax.reload();
            },
            error: function(xhr) {
                alert("Error al guardar ‚ùå: " + xhr.responseText);
            }
        });
    });
});
</script>

<div class="bloque-vista">
    <h2>üìä Proyecci√≥n presupuesto centro operacion-segmento Ventas</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">üîÑ Cargar desde hist√≥rico</button>
        {% comment %} <button type="button" id="guardarBtn" class="btn-accion btn-guardar">üíæ Guardar cambios</button> {% endcomment %}
    </div>

    <table id="presupuestoTableCentroOperacionSegmento" class="display" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Segmento</th>
                <th>Centro de operacion</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total A√±o Ventas</th>
                <th>Total A√±o Costos</th>
                <th>Variaci√≥n Valor Ventas</th>
                <th>Variaci√≥n Ventas%</th>
                <th>Margen %</th>
                <th>Margen Valor </th>
                <th>Total proyectado</th>
        </thead>
         <tbody></tbody>
    </table>
</div>

<style>
    .fila-r2 {
        background-color: #f0f0f0;
        font-weight: bold;
    }
</style>

<script>
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
        return data;
    }

    // üîÑ Pivotar datos y separar fila R2 por centro y segmento
    function pivoData(data, selectedCentro=null, selectedSegmento=null) { 
        let pivot = {};
        let meses = { 1:"Ene",2:"Feb",3:"Mar",4:"Abr",5:"May",6:"Jun",7:"Jul",8:"Ago",9:"Sep",10:"Oct",11:"Nov",12:"Dic" };

        data.forEach(row => {
            let key = row.year + '_' + row.nombre_centro_operacion + '_' + row.segmento;
            if (!pivot[key]) {
                pivot[key] = { 
                    year: row.year, 
                    nombre_centro_operacion: row.nombre_centro_operacion, 
                    segmento: row.segmento, 
                    total_year: row.total_year, 
                    total_year_costos: row.total_year_costos,
                    variacion_valor: row.variacion_valor, 
                    variacion_pct: row.variacion_pct,
                    utilidad_pct: row.utilidad_pct,
                    utilidad_valor: row.utilidad_valor,
                    total_proyectado: row.total_proyectado
                };
            } 
            pivot[key][meses[row.mes]] = row.total; 

            {% comment %} let r2Key = 'R2_' + row.nombre_centro_operacion + '_' + row.segmento;
            if (!pivot[r2Key]) pivot[r2Key] = { year: "R2", nombre_centro_operacion: row.nombre_centro_operacion, segmento: row.segmento, total_year: 0, variacion_valor: 0, variacion_pct: 0 }; 
            pivot[r2Key][meses[row.mes]] = row.r2;  {% endcomment %}
        });
        let result = Object.values(pivot);

        // si hay filtro de centro o segmento, agregar fila R2 al final
        {% comment %} if (selectedCentro != null || selectedSegmento != null) {
            result = result.map(r => {
                if (r.year === "R2" && r.nombre_centro_operacion === selectedCentro && r.segmento === selectedSegmento) {
                    let emptyR2 = {...r};
                    Object.keys(meses).forEach(m => emptyR2[meses[m]] = "");
                    return emptyR2;
                }
                return r;
            });
        } {% endcomment %}
        return result;
    }

    // üîÑ Despivotar datos ignorando fila R2 para enviar al backend
    function unpivotData(tableData) {
        let meses = { "Ene":1,"Feb":2,"Mar":3,"Abr":4,"May":5,"Jun":6,"Jul":7,"Ago":8,"Sep":9,"Oct":10,"Nov":11,"Dic":12 };
        let result = [];
        tableData.forEach(row => {
            {% comment %} if(row.year === "R2") return;  {% endcomment %}
            Object.keys(meses).forEach(m => {
                if(row[m] !== undefined){
                    result.push({
                        year: parseInt(row.year),
                        mes: meses[m],
                        segmento: row.segmento,
                        nombre_centro_operacion: row.nombre_centro_operacion,
                        total: parseInt(row[m]),
                        r2: 0 // se recalcular√° en el backend
                    });
                }
            });
        });
        return result;
    }

    $(function () {
        let table = null;
        let allData = []; // almacenar todos los datos cargados

        function pivoDataR2Final(data) {
            let meses = {1:"Ene",2:"Feb",3:"Mar",4:"Abr",5:"May",6:"Jun",7:"Jul",8:"Ago",9:"Sep",10:"Oct",11:"Nov",12:"Dic"};
            let pivot = {};
            let r2Rows = [];

            // crear pivot por a√±o + centro + segmento
            data.forEach(row => {
                let key = row.year + '_' + row.nombre_centro_operacion + '_' + row.segmento;
                if (!pivot[key]) pivot[key] = { year: row.year, nombre_centro_operacion: row.nombre_centro_operacion, segmento: row.segmento, total_year: row.total, variacion_valor: row.variacion_valor, variacion_pct: row.variacion_pct };
                pivot[key][meses[row.mes]] = row.total;

                // almacenar fila R2 por centro + segmento
                {% comment %} if (!pivot['R2_' + row.nombre_centro_operacion + '_' + row.segmento]) {
                    let r2Row = { year: "R2", nombre_centro_operacion: row.nombre_centro_operacion, segmento: row.segmento, total_year: 0, variacion_valor: 0, variacion_pct: 0 };
                    r2Row[meses[row.mes]] = row.r2;
                    r2Rows.push(r2Row);
                    pivot['R2_' + row.nombre_centro_operacion + '_' + row.segmento] = r2Row;
                } else {
                    pivot['R2_' + row.nombre_centro_operacion + '_' + row.segmento][meses[row.mes]] = row.r2;
                } {% endcomment %}
            });

            // generar array final con R2 al final de cada centro + segmento
            let groupedByCentroSegmento = {};
            Object.values(pivot).forEach(row => {
                {% comment %} if (row.year === "R2") return;  {% endcomment %}
                let key = row.nombre_centro_operacion + '_' + row.segmento;
                if (!groupedByCentroSegmento[key]) groupedByCentroSegmento[key] = [];
                groupedByCentroSegmento[key].push(row);
            });

            let finalData = [];
            Object.values(groupedByCentroSegmento).forEach(rows => {
                finalData = finalData.concat(rows);
                // agregar fila R2 correspondiente
                let centro = rows[0].nombre_centro_operacion;
                let segmento = rows[0].segmento;
                let r2Row = r2Rows.find(r => r.nombre_centro_operacion === centro && r.segmento === segmento);
                if (r2Row) finalData.push(r2Row);
            });
            return finalData;
        }

        function loadTable(data) {
            allData = data; // almacenar todos los datos cargados
            let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            let columns = [{ data: 'year', title: 'A√±o' },
                        { data: 'segmento', title: 'Segmento' },
                        { data: 'nombre_centro_operacion', title: 'Centro de operacion' }];
            meses.forEach(m => 
                columns.push({ data: m, title: m, render: numberFormat, className: "editable" }));
            
            // ‚ûï columnas extra
            columns.push({ data: "variacion_valor", title: "Variaci√≥n Valor", render: numberFormat });
            columns.push({ data: "variacion_pct", title: "Variaci√≥n Ventas%", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
            columns.push({ data: "total_year", title: "Total A√±o Ventas", render: numberFormat });
            columns.push({ data: "total_year_costos", title: "Total A√±o Costos", render: numberFormat });
            columns.push({ data: "utilidad_pct", title: "Margen %", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});
            columns.push({ data: "utilidad_valor", title: "Margen Valor", render: numberFormat });
            columns.push({ data: "total_proyectado", title: "Total proyectado", render: numberFormat });
            
            if (table) {
                table.destroy();
                $('#presupuestoTableCentroOperacionSegmento').empty(); 
                $(".dt-buttons").remove();           // üîπ elimina los botones Excel previos
            }

            table = $('#presupuestoTableCentroOperacionSegmento').DataTable({
                data: pivoData(data),
                columns: columns,
                paging: false,
                scrollX: true,
                scrollY: "300px",
                scrollCollapse: true,
                fixedHeader: true,
                dom: 'Bltip',
                buttons:[{ extend:'excelHtml5', text:'üì• Exportar a Excel', title:'Presupuesto Centro Operaci√≥n Segmento ventas'}],
                rowCallback: function(row, data) {
                    if (data.year === "R2") {
                        $(row).addClass('fila-r2');
                    }
                },
                columnDefs: [
                    {
                        targets: 0,
                        type: "string",
                        render: function (data, type, row) {
                            if (type === 'sort') return data === "R2" ? "ZZZ" : data;
                            return data;
                        }
                    }
                ],
                order: [[0, "asc"], [1, "asc"], [2, "asc"]]
            });

            // Mover bot√≥n Excel
            let wrapper = $(table.table().container());
            wrapper.find('.dt-buttons').detach().appendTo('.bloque-vista .btn-group');

            // Filtros tipo Excel
            table.columns().every(function (index) {
                if (index === 0 || index === 1 || index === 2) {   // üîπ 0 = A√±o, 1 = segmento, 2 = Centro de operaci√≥n
                    let column = this;
                    // id dinamico
                    let filtroId = index === 0 ? "a√±o" : (index === 1 ? "segmento" : "centro");

                    // Bot√≥n en el header
                    let button = $(`<button id="excel-filter-btn-${filtroId}" class="excel-filter-btn">
                                        ${index === 0 ? "A√±o ‚¨á" : (index === 1 ? "Segmento ‚¨á" : "Centro ‚¨á")}
                                    </button>`).appendTo($(column.header()).empty());

                    // Contenedor del men√∫
                    let menu = $(`<div id="excel-filter-${filtroId}" class="excel-filter"></div>`).appendTo("body");

                    // Input de b√∫squeda
                    let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                    // Lista de checkboxes
                    let list = $("<div></div>").appendTo(menu);

                    // Agregar opciones √∫nicas como checkboxes
                    column.data().unique().sort().each(function (d) {
                        if (d) {
                            list.append(`<label><input type="checkbox" value="${d}" checked> ${d}</label><br/>`);
                        }
                    });

                    // Funci√≥n aplicar filtro
                    function applyFilter() {
                        let selected = [];
                        menu.find("input[type='checkbox']:checked").each(function () {
                            selected.push("^" + $.fn.dataTable.util.escapeRegex($(this).val()) + "$");
                        });
                        column.search(selected.length ? selected.join("|") : "", true, false).draw();
                    }

                    // Evento checkbox
                    list.on("change", "input[type='checkbox']", applyFilter);

                    // Evento b√∫squeda dentro del men√∫
                    searchBox.on("keyup", function () {
                        let val = $(this).val().toLowerCase();
                        list.find("label").each(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });

                    // Mostrar este men√∫ y ocultar los dem√°s
                    button.on("click", function (e) {
                        e.stopPropagation();

                        // üîπ Ocultar otros men√∫s antes de abrir este
                        $(".excel-filter").not(menu).hide();

                        // Posicionar y mostrar este
                        let offset = $(this).offset();
                        menu.css({
                            top: offset.top + $(this).outerHeight(),
                            left: offset.left,
                            width: $(this).outerWidth()
                        }).toggle();
                    });

                    // Cerrar men√∫ al hacer clic fuera
                    $(document).on("click", function (e) {
                        if (!$(e.target).closest(`#excel-filter-${filtroId}, button`).length) {
                            menu.hide();
                        }
                    });
                }
            });

            // edici√≥n doble clic solo 2025
            let editingCell = null;
            $('#presupuestoTableCentroOperacionSegmento').on('dblclick', 'td.editable', function () {
                if (editingCell) return; // ya hay una celda en edici√≥n
                let cell = table.cell(this);
                let rowData = table.row(this).data();
                if (rowData.year !== 2026) return; // solo permitir edici√≥n en a√±o
                let oldValue = cell.data() || "";
                $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
                let $input = $(this).find('input').focus();
                editingCell = this;
                $input[0].setSelectionRange(0, $input.val().length);

                $input.on('keydown', function(e) {
                    if (e.key === 'Enter') { 
                        cell.data($input.val()).draw(false); 
                        editingCell = null;
                        
                        // actualizar allData
                        let colName = table.column(cell.index().column).dataSrc();
                        let meses = { "Ene":1,"Feb":2,"Mar":3,"Abr":4,"May":5,"Jun":6,"Jul":7,"Ago":8,"Sep":9,"Oct":10,"Nov":11,"Dic":12 };
                        let mesNum = meses[colName];

                        if (mesNum){
                            let match = allData.find(d => d.year === rowData.year && d.nombre_centro_operacion === rowData.nombre_centro_operacion && d.segmento === rowData.segmento && d.mes === mesNum);
                            if (match) {
                                match.total = parseInt($input.val().replace(/\./g, '')) || 0;
                            } 
                        }
                    }
                    else if (e.key === 'Escape') { cell.data(oldValue).draw(false); editingCell = null; }
                });
            });
            // Guardar al hacer clic fuera
            $(document).on('click', function(e) {
                if (editingCell) {
                    let $cell = $(editingCell);
                    let $input = $cell.find('input');
                    if ($input.length && !$(e.target).closest('#presupuestoTableCentroOperacionSegmento').length) {
                        let cell = table.cell(editingCell);
                        cell.data($input.val()).draw(false);
                        editingCell = null;
                    }
                }
            });
        }

        // Cargar historico
        $('#cargarBtn').on('click', function() {
            let boton = $(this);
            boton.prop('disabled', true).append('<span class="spinner"></span>');

            $.ajax({
                url: "{% url 'cargar_presupuesto_centro_segmento_ventas' %}",
                method: "GET",
                dataType: "json",
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    console.log("Datos cargados:", datos);
                    loadTable(datos);
                },
                error: function(err) {
                    alert("Error al cargar datos: " + (err.responseJSON?.mensaje || err.statusText));
                },
                complete: function() {
                    boton.prop('disabled', false).find('.spinner').remove();
                }
            });
        });

        // Guardar cambios
        $('#guardarBtn').on('click', function() {
            if (!table) return;
            let boton = $(this);
            boton.prop('disabled', true).append('<span class="spinner"></span>');
            let data = unpivotData(pivoData(allData)); 

            $.ajax({
                url: "{% url 'guardar_presupuesto_centro_segmento_ventas' %}",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify(data),
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    alert("Presupuesto guardado correctamente ‚úÖ");
                    loadTable(datos); // recargar tabla con datos actualizados
                },
                error: function(err) {
                    alert("Error al guardar datos: " + (err.responseJSON?.mensaje || err.statusText));
                },
                complete: function() {
                    boton.prop('disabled', false).find('.spinner').remove();
                }
            });
        });
        // Carga inicial
        $.ajax({
            url:"{% url 'obtener_presupuesto_centro_segmento_ventas' %}",
            type:"GET",
            dataType:"json",
            success:function(resp){ let datos=Array.isArray(resp)?resp:resp.data; loadTable(datos); }
        });
    });

</script>

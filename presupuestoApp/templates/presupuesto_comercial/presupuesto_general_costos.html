{% extends "presupuesto_comercial/base_presupuesto_comercial.html" %}
{% load static %}

{% block css %}
<style>
    table.dataTable thead th {
      background-color: #007bff;
      color: white;
    }
    .excel-filter {
        display: none;
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        padding: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        width: 150px !important;   /* ajusta a lo que necesites */
        min-width: 80px;          /* opcional */
    }
    .excel-filter input[type="text"] {
        width: 95%;
        margin-bottom: 6px;
        padding: 3px;
    }
    .excel-filter-btn {
        width: 100%;
        padding: 4px 6px;
        background: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        text-align: left;
    }
</style>
{% endblock %}

{% block content %}
<div class="bloque-vista">
    <h2>ðŸ“Š ProyecciÃ³n presupuesto general - Costos</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">ðŸ”„ Cargar desde histÃ³rico</button>
        {% comment %} <button type="button" id="guardarBtn" class="btn-accion btn-guardar">ðŸ’¾ Guardar cambios</button> {% endcomment %}
    </div>

    <table id="presupuestoTableProyeccionGeneralCostos" class="display" style="width:100%">
        <thead>
            <tr>
                <th>AÃ±o</th>
                <th>Ene</th>
                <th>Feb</th>
                <th>Mar</th>
                <th>Abr</th>
                <th>May</th>
                <th>Jun</th>
                <th>Jul</th>
                <th>Ago</th>
                <th>Sep</th>
                <th>Oct</th>
                <th>Nov</th>
                <th>Dic</th>
                <th>Total AÃ±o</th>
                <th>VariaciÃ³n Valor</th>
                <th>VariaciÃ³n %</th>
            </tr>
        </thead>
    </table>
</div>
{% endblock %}

{% block js %}
<script>
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
        return data;
    }

    // ðŸ”„ Pivotar datos y separar fila R2
    function pivotData(data) { 
        let pivot = {}; 
        let meses = { 1: "Ene", 2: "Feb", 3: "Mar", 4: "Abr", 5: "May", 6: "Jun", 7: "Jul", 8: "Ago", 9: "Sep", 10: "Oct", 11: "Nov", 12: "Dic" }; 
        data.forEach(row => { 
            if (!pivot[row.year]) pivot[row.year] = { year: row.year, total_year: row.total_year, variacion_valor: row.variacion_valor, variacion_pct: row.variacion_pct }; 
            pivot[row.year][meses[row.mes]] = row.total; 
            {% comment %} if (!pivot["R2"]) pivot["R2"] = { year: "R2", total_year: 0, variacion_valor: 0, variacion_pct: 0 }; 
            pivot["R2"][meses[row.mes]] = row.r2;  {% endcomment %}
        }); 
        return Object.values(pivot); 
    }

    function unpivotData(tableData) {
        let meses = { "Ene":1, "Feb":2, "Mar":3, "Abr":4, "May":5, "Jun":6, "Jul":7, "Ago":8, "Sep":9, "Oct":10, "Nov":11, "Dic":12 };
        let result = [];
        tableData.forEach(row => {
            {% comment %} if(row.year === "R2") return;  {% endcomment %}
            Object.keys(meses).forEach(m => {
                if(row[m] !== undefined){
                    result.push({
                        year: parseInt(row.year),
                        mes: meses[m],
                        total: parseInt(row[m]),
                        r2: 0 // se recalcularÃ¡ en el backend
                    });
                }
            });
        });
        return result;
    }

    $(document).ready(function () {
        let table = null;

        function loadTable(data) {
            let meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
            let columns = [{ data: 'year', title: 'AÃ±o' }];
            meses.forEach(m => {
                columns.push({ data: m, title: m, render: numberFormat, className: "editable" });
            });

            // âž• columnas extra
            columns.push({ data: "total_year", title: "Total AÃ±o", render: numberFormat });
            columns.push({ data: "variacion_valor", title: "VariaciÃ³n Valor", render: numberFormat });
            columns.push({ data: "variacion_pct", title: "VariaciÃ³n %", render: function(data){ return data ? data.toFixed(2) + "%" : "0%"; }});

            if (table) {
                table.destroy();
                $('#presupuestoTableProyeccionGeneralCostos').empty();
                $("#excel-filter-costos").remove();  // ðŸ”¹ elimina menÃºs anteriores
                $(".dt-buttons").remove();           // ðŸ”¹ elimina los botones Excel previos
            }

            table = $('#presupuestoTableProyeccionGeneralCostos').DataTable({
                data: pivotData(data),
                columns: columns,
                paging: false,
                scrollX: true,
                fixedHeader: true,
                dom: 'Bltip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: 'ðŸ“¥ Exportar a Excel',
                        title: 'Presupuesto General Costos'
                    }
                ],
                {% comment %} rowCallback: function(row, data) {
                    if (data.year === "R2") $(row).addClass("fila-r2");
                }, {% endcomment %}
                columnDefs: [
                    {
                        targets: 0,
                        type: "string",
                        render: function (data, type, row) {
                            if (type === 'sort') return data === "R2" ? "ZZZ" : data;
                            return data;
                        }
                    }
                ],
                order: [[0, "asc"]]
            });

            // Mover botÃ³n Excel
            let wrapper = $(table.table().container()); 
            wrapper.find(".dt-buttons").appendTo(wrapper.closest(".bloque-vista").find(".btn-group"));

            // Filtro en columna AÃ±o
            table.columns().every(function (index) {
                if (index === 0) {
                    let column = this;
                    // BotÃ³n en el header
                    let button = $('<button id="excel-filter-btn-costos" class="excel-filter-btn">AÃ±o â¬‡</button>').appendTo($(column.header()).empty());

                    // Contenedor del menÃº
                    let menu = $('<div id="excel-filter-costos" class="excel-filter"></div>').appendTo('body');

                    // Input de bÃºsqueda
                    let searchBox = $('<input type="text" placeholder="Buscar...">').appendTo(menu);

                    // Lista de checkboxes
                    let list = $('<div></div>').appendTo(menu);

                    // Agregar opciones Ãºnicas como checkboxes
                    column.data().unique().sort().each(function (d) {
                        if (d) {
                            list.append('<label><input type="checkbox" value="' + d + '" checked> ' + d + '</label><br/>');
                        }
                    });

                    // FunciÃ³n aplicar filtro
                    function applyFilter() {
                        let selected = [];
                        menu.find('input[type="checkbox"]:checked').each(function () {
                            selected.push('^' + $.fn.dataTable.util.escapeRegex($(this).val()) + '$');
                        });
                        column.search(selected.length ? selected.join('|') : '', true, false).draw();
                    }

                    // Evento checkbox
                    list.on('change', 'input[type="checkbox"]', applyFilter);

                    // Evento bÃºsqueda dentro del menÃº
                    searchBox.on('keyup', function () {
                        let val = $(this).val().toLowerCase();
                        list.find("label").each(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });

                    // Mostrar/ocultar menÃº
                    button.on('click', function (e) {
                        e.stopPropagation();
                        let offset = $(this).offset();
                        menu.css({
                            top: offset.top + $(this).outerHeight(),
                            left: offset.left,
                            width: $(this).outerWidth()
                        }).toggle();
                    });

                    // Cerrar menÃº al hacer clic fuera
                    $(document).on('click', function (e) {
                        if (!$(e.target).closest('#excel-filter-costos, button').length) {
                            menu.hide();
                        }
                    });
                }
            });

            // EdiciÃ³n doble clic solo 2025
            let editingCell = null;
            $('#presupuestoTableProyeccionGeneralCostos').on('dblclick', 'td.editable', function () {
                if (editingCell) return;
                let cell = table.cell(this);
                let rowData = table.row(this).data();
                if (rowData.year !== 2025) return;

                let oldValue = cell.data() || "";
                $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
                let $input = $(this).find("input").focus();
                editingCell = this;
                $input[0].setSelectionRange(0, $input.val().length);

                $input.on("keydown", function(e) {
                    if (e.key === "Enter") { cell.data($input.val()).draw(false); editingCell = null; }
                    else if (e.key === "Escape") { cell.data(oldValue).draw(false); editingCell = null; }
                });
            });

            // Guardar al hacer clic fuera
            $(document).on("click", function(e) {
                if (editingCell) {
                    let $cell = $(editingCell);
                    let $input = $cell.find("input");
                    if ($input.length && !$(e.target).closest("#presupuestoTableProyeccionGeneralCostos").length) {
                        let cell = table.cell(editingCell);
                        cell.data($input.val()).draw(false);
                        editingCell = null;
                    }
                }
            });
        }

        // ðŸ”„ Cargar desde histÃ³rico
        $(document).on("click", "#cargarBtn", function () {
            let boton = $(this);
            boton.prop("disabled", true).append('<span class="spinner"></span>');

            $.ajax({
                url: "{% url 'cargar_presupuesto_general_costos' %}",
                type: "GET",
                dataType: "json", // <- importante
                success: function(resp) {
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    loadTable(datos);
                },
                error: function(err) {
                    console.error("Error AJAX:", err);
                },
                complete: function() {
                    boton.prop("disabled", false).find(".spinner").remove();
                }
            });
        });

        // ðŸ’¾ Guardar cambios
        $(document).on("click", "#guardarBtn", function () {
            if (!table) return;
            let boton = $(this);
            boton.prop("disabled", true).append('<span class="spinner"></span>');
            let data = unpivotData(table.rows().data().toArray());

            $.ajax({
                url: "{% url 'guardar_presupuesto_general_costos' %}",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                success: function(resp) { 
                    // si el servidor devuelve {data: [...]}
                    let datos = Array.isArray(resp) ? resp : resp.data;
                    loadTable(datos); 
                },
                complete: function() {
                    boton.prop("disabled", false).find(".spinner").remove();
                }
            });
        });

        // Primera carga automÃ¡tica
        $.ajax({
            url: "{% url 'obtener_presupuesto_general_costos' %}",
            type: "GET",
            dataType: "json",
            success: function(resp) {
                let datos = Array.isArray(resp) ? resp : resp.data;
                loadTable(datos);
            }
        });
    });
</script>
{% endblock %}

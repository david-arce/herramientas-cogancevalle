<div class="bloque-vista">
    <h2>üìä Proyecci√≥n presupuesto general - Costos</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn">üîÑ Cargar desde hist√≥rico</button>
        <button type="button" id="guardarBtn">üíæ Guardar cambios</button>
    </div>

    <table id="presupuestoTableProyeccionGeneralCostos" class="display" style="width:100%">
        <thead>
            <tr>
                <th>A√±o</th>
                <th>Mes</th>
                <th>Total</th>
                <th>R2 %</th>
            </tr>
        </thead>
    </table>
</div>

<script>
function numberFormat(data, type, row) {
    if (type === 'display' && !isNaN(data)) {
        return new Intl.NumberFormat('es-ES').format(data);
    }
    return data;
}

$(function () {   // ‚ö° $(function() {}) == $(document).ready()
    let table = $('#presupuestoTableProyeccionGeneralCostos').DataTable({
        ajax: {
            url: "{% url 'obtener_presupuesto_general_costos' %}",
            dataSrc: ""
        },
        columns: [
            { data: "year" },
            { data: "mes" },
            { data: "total" },
            { data: "r2"}
        ],
        columnDefs: [
            { targets: [2,3], render: numberFormat },
            { targets: [2], className: "editable" }
        ]
    });

    
    let editingCell = null;
    // Doble clic para editar SOLO si el a√±o es 2025
    $('#presupuestoTableProyeccionGeneralCostos').on('dblclick', 'td.editable', function () {
        if (editingCell) return;

        let cell = table.cell(this);
        let rowData = table.row(this).data();  // obtiene toda la fila

        if (rowData.year !== 2025) {
            // üö´ Bloquear edici√≥n
            return;
        }

        let oldValue = cell.data();
        $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
        let $input = $(this).find("input").focus();
        editingCell = this;

        $input[0].setSelectionRange(0, $input.val().length);

        $input.on("keydown", function(e) {
            if (e.key === "Enter") {
                cell.data($input.val()).draw(false);
                editingCell = null;
            } else if (e.key === "Escape") {
                cell.data(oldValue).draw(false);
                editingCell = null;
            }
        });
    });

    // Guardar cuando haces clic fuera
    $(document).on("click", function(e) {
        if (editingCell) {
            let $cell = $(editingCell);
            let $input = $cell.find("input");
            if ($input.length && !$(e.target).closest("#presupuestoTableProyeccionGeneralCostos").length) {
                let cell = table.cell(editingCell);
                cell.data($input.val()).draw(false);
                editingCell = null;
            }
        }
    });

    // üîÑ Bot√≥n cargar desde hist√≥rico
    $(document).on("click", "#cargarBtn", function () {
        $.ajax({
            url: "{% url 'cargar_presupuesto_general_costos' %}",
            type: "GET",
            success: function() {
                alert("Datos recalculados y cargados desde hist√≥rico ‚úÖ");
                table.ajax.reload();
            },
            error: function(xhr) {
                alert("Error al cargar desde hist√≥rico ‚ùå " + xhr.responseText);
            }
        });
    });

    // üíæ Bot√≥n guardar cambios
    $(document).on("click", "#guardarBtn", function () {
        let data = table.rows().data().toArray();

        $.ajax({
            url: "{% url 'guardar_presupuesto_general_costos' %}",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function() {
                alert("Cambios guardados ‚úÖ");
                table.ajax.reload();
            },
            error: function(xhr) {
                alert("Error al guardar ‚ùå: " + xhr.responseText);
            }
        });
    });
});
</script>

<div class="bloque-vista">
    <h2>📊 Proyección presupuesto centro operacion - Ventas</h2>

    <div class="btn-group">
        <button type="button" id="cargarBtn" class="btn-accion">🔄 Cargar desde histórico</button>
        <button type="button" id="guardarBtn" class="btn-accion btn-guardar">💾 Guardar cambios</button>
    </div>

    <table id="presupuestoTableCentroOperacionCostos" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Año</th>
                <th>Mes</th>
                <th>Centro de operacion</th>
                <th>Total</th>
                <th>R2 %</th>
            </tr>
            <tr class="filters"> <!-- Filtros arriba -->
                <th></th> <!-- select año -->
                <th></th> <!-- select mes -->
                <th></th> <!-- select centro -->
                <th><input type="text" placeholder="🔍 Total" style="width:100%"></th>
                <th><input type="text" placeholder="🔍 R2 %" style="width:100%"></th>
            </tr>
        </thead>
    </table>
</div>

<script>
function numberFormat(data, type, row) {
    if (type === 'display' && !isNaN(data)) {
        return new Intl.NumberFormat('es-ES').format(data);
    }
    return data;
}

$(function () {   // ⚡ $(function() {}) == $(document).ready()
    // 🟢 Agregar inputs de búsqueda en cada columna (tfoot)
    $('#presupuestoTableProyeccionGeneral tfoot th').each(function () {
        let title = $(this).text();
        $(this).html('<input type="text" placeholder="🔍 ' + title + '" style="width:100%"/>');
    });
    let table = $('#presupuestoTableCentroOperacionCostos').DataTable({
        ajax: {
            url: "{% url 'obtener_presupuesto_centro_costos' %}",
            dataSrc: ""
        },
        columns: [
            { data: "year" },
            { data: "mes" },
            { data: "centro_operacion" },
            { data: "total" },
            { data: "r2"}
        ],
        columnDefs: [
            { targets: [3,4], render: numberFormat },
            { targets: [3], className: "editable" }
        ],
        orderCellsTop: true,
        fixedHeader: true,
        dom: 'Bltip', // 👈 mantiene el selector de filas y agrega botones
        buttons: [
            {
                extend: 'excelHtml5',
                text: '📥 Exportar a Excel',
                title: 'Presupuesto General Ventas'
            }
        ]
    });

    // 🟢 Configurar filtros dinámicos
    table.on('init.dt', function () {
        // Mueve el botón de Excel al grupo de botones personalizado
        $(".dt-buttons").appendTo(".btn-group");
        table.columns().every(function (index) {
            let column = this;
            let headerCell = $('thead tr.filters th').eq(index);

            if (index === 0 || index === 1 || index === 2) {
                // 👉 Año y Mes con select
                let select = $('<select><option value="">Todos</option></select>')
                    .appendTo(headerCell.empty())
                    .on('change', function () {
                        let val = $.fn.dataTable.util.escapeRegex($(this).val());
                        column.search(val ? '^' + val + '$' : '', true, false).draw();
                    });

                // Llenar opciones únicas
                column.data().unique().sort().each(function (d) {
                    if (d) {
                        select.append('<option value="' + d + '">' + d + '</option>');
                    }
                });
            } else {
                // 👉 Total y R2 con input texto
                $('<input type="text" placeholder="🔍" style="width:100%"/>')
                    .appendTo(headerCell.empty())
                    .on('keyup change clear', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
            }
        });
    });
    
    let editingCell = null;
    // Doble clic para editar SOLO si el año es 2025
    $('#presupuestoTableCentroOperacionCostos').on('dblclick', 'td.editable', function () {
        if (editingCell) return;

        let cell = table.cell(this);
        let rowData = table.row(this).data();  // obtiene toda la fila

        if (rowData.year !== 2025) {
            // 🚫 Bloquear edición
            return;
        }

        let oldValue = cell.data();
        $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
        let $input = $(this).find("input").focus();
        editingCell = this;

        $input[0].setSelectionRange(0, $input.val().length);

        $input.on("keydown", function(e) {
            if (e.key === "Enter") {
                cell.data($input.val()).draw(false);
                editingCell = null;
            } else if (e.key === "Escape") {
                cell.data(oldValue).draw(false);
                editingCell = null;
            }
        });
    });

    // Guardar cuando haces clic fuera
    $(document).on("click", function(e) {
        if (editingCell) {
            let $cell = $(editingCell);
            let $input = $cell.find("input");
            if ($input.length && !$(e.target).closest("#presupuestoTableCentroOperacionCostos").length) {
                let cell = table.cell(editingCell);
                cell.data($input.val()).draw(false);
                editingCell = null;
            }
        }
    });

    // 🔄 Botón cargar desde histórico
    $(document).on("click", "#cargarBtn", function () {
        let boton = $(this);
        boton.prop("disabled", true);
        boton.append('<span class="spinner"></span>');
        $.ajax({
            url: "{% url 'cargar_presupuesto_centro_costos' %}",
            type: "GET",
            success: function() {
                table.ajax.reload();
            },
            error: function(xhr) {
            },
            complete: function() {
                boton.prop("disabled", false);
                boton.find(".spinner").remove();
            }
        });
    });

    // 💾 Botón guardar cambios
    $(document).on("click", "#guardarBtn", function () {
        let data = table.rows().data().toArray();
        let boton = $(this);
        boton.prop("disabled", true);
        boton.append('<span class="spinner"></span>');
        $.ajax({
            url: "{% url 'guardar_presupuesto_centro_costos' %}",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function() {
                table.ajax.reload();
            },
            error: function(xhr) {
            },
            complete: function() {
                boton.prop("disabled", false);
                boton.find(".spinner").remove();
            }
        });
    });
});
</script>

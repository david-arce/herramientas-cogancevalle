{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Presupuesto N√≥mina Temporal</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- DataTables Buttons CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <!-- Select2 (para b√∫squeda dentro de select) -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- üîπ FixedHeader CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
    <!-- üîπ FixedHeader JS -->
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/nomina_auxiliares.css' %}">
</head>
<body>
    <h2>Presupuesto N√≥mina - Tabla Auxiliar Sueldos</h2>
    <div class="btn-group">
        <span>Incremento salarial (%): <strong>{{ incrementoSalarial|default:"0" }}</strong></span>
        <button id="cargarBase">
            Cargar desde Conceptos
            <span class="spinner" style="display:none; margin-left:8px;"></span>
        </button>

        <button id="calcularBtn">Calcular</button>
        <button id="agregarFila">‚ûï Agregar fila</button>
        <button id="guardarTempBtn">Guardar cambios<span class="spinner" style="display:none; margin-left:8px;"></span>
        </button>
        <button id="btnTabla"> Ir a tabla principal</button>
        <button id="btnHome"> Inicio</button>
    </div>

    <form id="subirPresupuestoForm" method="post" action="{% url 'subir_presupuesto_sueldos' %}">
        {% csrf_token %}
        <button type="submit" id="subirBtn" class="btn btn-success">
            Subir Presupuesto sueldos
        </button>
    </form>
    <!-- üîπ Filtros con b√∫squeda interna -->
    <div class="filtros-container">
        <div class="filtro-box">
            <label for="filtroNombre">Nombre:</label>
            <select id="filtroNombre">
                <option value="">Todos</option>
            </select>
        </div>

        <div class="filtro-box">
            <label for="filtroCentro">Centro:</label>
            <select id="filtroCentro">
                <option value="">Todos</option>
            </select>
        </div>

        <div class="filtro-box">
            <label for="filtroArea">√Årea:</label>
            <select id="filtroArea">
                <option value="">Todos</option>
            </select>
        </div>
    </div>
    <table id="tempTable" class="display">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAllIPC" title="Seleccionar todo"></th>
                <th>Acciones</th>
                <th>Cedula</th>
                <th>Nombre</th>
                <th>Centro</th>
                <th>Area</th>
                <th>Cargo</th>
                <th>Concepto</th>
                <th>Salario base</th>
                <th>Enero</th>
                <th>Febrero</th>
                <th>Marzo</th>
                <th>Abril</th>
                <th>Mayo</th>
                <th>Junio</th>
                <th>Julio</th>
                <th>Agosto</th>
                <th>Septiembre</th>
                <th>Octubre</th>
                <th>Noviembre</th>
                <th>Diciembre</th>
                <th>Total</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th colspan="21" style="text-align:right">Total visible:</th>
                <th id="footer-total">0</th>
            </tr>
        </tfoot>
    </table>

    <!-- Contenedor de toasts -->
    <div class="toast-container" id="toastContainer"></div>

<script>
$(document).ready(function() {
    // Bot√≥n Ir a la tabla presupuesto nomina
    document.getElementById("btnTabla").addEventListener("click", function () {
        window.location.href = "{% url 'sueldos' %}";
    });
    // Bot√≥n Ir al inicio
    document.getElementById("btnHome").addEventListener("click", function () {
        window.location.href = "{% url 'presupuestoNomina' %}";
    });
    function numberFormat(data, type, row) {
        if (type === 'display' && !isNaN(data)) {
            return new Intl.NumberFormat('es-ES').format(data);
        }
    return data;
    }
    let table = $('#tempTable').DataTable({
        ajax: {
            url: "{% url 'obtener_nomina_temp' %}",
            dataSrc: ""
        },
        columns: [
            { 
                data: null,
                defaultContent: '<input type="checkbox" class="row-check" title="Seleccionar fila">',
                orderable: false
            },
            { 
                data: null,
                defaultContent: `
                        <div class="btn-group-tabla">
                            <button class="copiarFila" title="Copiar fila">üìã</button>
                            <button class="duplicarFila" title="Duplicar fila">üìë</button>
                            <button class="eliminarFila" title="Eliminar fila">‚ùå</button>
                        </div>
                    `,
                orderable: false
            },
            { data: "cedula" },
            { data: "nombre" },
            { data: "centro" },
            { data: "area" },
            { data: "cargo" },
            { data: "concepto" },
            { data: "salario_base", render: numberFormat },
            { data: "enero", render: numberFormat },
            { data: "febrero", render: numberFormat },
            { data: "marzo", render: numberFormat },
            { data: "abril", render: numberFormat },
            { data: "mayo", render: numberFormat },
            { data: "junio", render: numberFormat },
            { data: "julio", render: numberFormat },
            { data: "agosto", render: numberFormat },
            { data: "septiembre", render: numberFormat },
            { data: "octubre", render: numberFormat },
            { data: "noviembre", render: numberFormat },
            { data: "diciembre", render: numberFormat },
            { data: "total", render: numberFormat },
            
        ],
        footerCallback: function (row, data, start, end, display) {
            let api = this.api();

            // üîπ Convierte valores a n√∫meros (limpia formato)
            let intVal = function (i) {
                return typeof i === 'string'
                    ? parseFloat(i.replace(/[\$,.]/g, '').replace(',', '.')) || 0
                    : typeof i === 'number'
                        ? i
                        : 0;
            };

            // üîπ Nombres de columnas num√©ricas (ajusta si cambia el orden)
            let columnasMeses = [
                "enero","febrero","marzo","abril","mayo","junio",
                "julio","agosto","septiembre","octubre","noviembre","diciembre"
            ];

            // üîπ Mapeo: nombre de columna ‚Üí √≠ndice en la tabla
            let colIndex = {};
            api.columns().every(function(idx) {
                let name = api.column(idx).dataSrc();
                if (columnasMeses.includes(name)) {
                    colIndex[name] = idx;
                }
                if (name === "total") {
                    colIndex["total"] = idx;
                }
            });

            // üîπ Calcular total visible por cada mes
            let totalesMeses = {};
            columnasMeses.forEach(mes => {
                totalesMeses[mes] = api
                    .column(colIndex[mes], { search: 'applied' })
                    .data()
                    .reduce((a, b) => a + intVal(b), 0);
            });

            // üîπ Calcular total visible general
            let totalVisible = api
                .column(colIndex["total"], { search: 'applied' })
                .data()
                .reduce((a, b) => a + intVal(b), 0);

            // üîπ Construir fila de totales
            let footerCells = [];
            for (let i = 0; i < api.columns().count(); i++) {
                let name = api.column(i).dataSrc();
                if (columnasMeses.includes(name)) {
                    footerCells.push(new Intl.NumberFormat('es-ES').format(totalesMeses[name]));
                } else if (name === "total") {
                    footerCells.push(new Intl.NumberFormat('es-ES').format(totalVisible));
                } else {
                    footerCells.push(""); // columnas sin total
                }
            }

            // üîπ Aplicar al footer (si existe)
            let $footerRow = $(api.table().footer()).find('tr');
            if ($footerRow.length === 0) {
                // crear si no existe
                $footerRow = $('<tr>').appendTo($(api.table().footer()));
            }

            $footerRow.empty();
            footerCells.forEach((cellValue, idx) => {
                let th = $('<th style="text-align:right;">').html(cellValue);
                $footerRow.append(th);
            });

            // üîπ Primera columna con texto ‚ÄúTotales:‚Äù
            $footerRow.find('th').eq(1).html("<strong>Totales visibles:</strong>");
        },
        language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        createdRow: function(row, data, dataIndex) {
            // üîπ Obtener el n√∫mero total de columnas
            let totalCols = this.api().columns().count();
            // marcar como editables s√≥lo columnas relevantes (excluyendo columna 0 = checkbox)
            $('td', row).each(function(index) {
                if (index > 1 && index < totalCols - 1) { // >0 excluye checkbox, <20 hasta "total"
                    $(this).addClass("editable");
                }
            });
        },
        dom: 'Bftip', // üî• agrega botones arriba de la tabla
        buttons: [
            {
                extend: 'excelHtml5',
                text: 'üì• Exportar a Excel',
                filename: 'presupuesto_nomina',
                exportOptions: {
                    modifier: {
                        page: 'all',   // üî• Exporta todas las p√°ginas
                        search: 'applied',
                        order: 'applied'
                    },
                    columns: ':not(:last-child)' // üî• excluye columna "Acciones"
                }
            }
        ],
        initComplete: function() {
            const api = this.api();

            // Funci√≥n que llena y activa Select2 con b√∫squeda interna
            function configurarSelect(colIndex, selector) {
                const valores = new Set();
                api.column(colIndex).data().each(d => { if (d) valores.add(d.trim()); });

                const sorted = Array.from(valores).sort((a,b)=>a.localeCompare(b));
                const $select = $(selector);
                $select.empty().append('<option value="">Todos</option>');
                sorted.forEach(v => $select.append(`<option value="${v}">${v}</option>`));

                // Activar Select2 con b√∫squeda
                $select.select2({
                    placeholder: 'Buscar...',
                    allowClear: true,
                    width: '200px'
                });

                // Filtrar DataTable cuando cambie el valor
                $select.on('change', function() {
                    const val = $.fn.dataTable.util.escapeRegex($(this).val());
                    api.column(colIndex).search(val ? '^' + val + '$' : '', true, false).draw();
                });
            }

            configurarSelect(3, '#filtroNombre'); // Nombre
            configurarSelect(4, '#filtroCentro'); // Centro
            configurarSelect(5, '#filtroArea');   // √Årea
        },
        paging: false,
        fixedHeader: true,
        autoWidth: false,
    });
    // üîπ Copiar fila al localStorage
    $('#tempTable').on('click', '.copiarFila', function() {
        let table = $('#tempTable').DataTable();
        let rowData = table.row($(this).parents('tr')).data();

        // Guardar en localStorage
        localStorage.setItem('filaCopiadaNomina', JSON.stringify(rowData));

        showToast("Fila copiada üìã (lista para pegar en Comisiones)", "success");
    });

    function seleccionarFila($row) {
            // Quitar selecci√≥n previa
            $('#tempTable tbody tr').removeClass('fila-activa');
            // Marcar la nueva fila
            $row.addClass('fila-activa');
    }
    // Seleccionar fila cuando se hace clic
    $('#tempTable').on('click', 'tbody tr', function() {
        seleccionarFila($(this));
    });
    // üîπ Agregar selects din√°micos en las filas despu√©s de cada redibujo
    table.on('draw', function() {
        // Agregar selects din√°micos en las columnas deseadas (centro, √°rea, cargo, concepto)
        $('#tempTable tbody tr').each(function() {
            let $row = $(this);
            let data = table.row($row).data();
            if (!data) return;

            // Generar selects si no existen
            if (!$row.find('.select-centro').length) {
                let selectCentro = `<select class="select-centro select2">
                    {% for c in centros %}
                        <option value="{{ c|escape }}">{{ c }}</option>
                    {% endfor %}
                </select>`;
                $row.find('td:eq(4)').html(selectCentro);
            }

            if (!$row.find('.select-area').length) {
                let selectArea = `<select class="select-area select2">
                    {% for a in areas %}
                        <option value="{{ a|escape }}">{{ a }}</option>
                    {% endfor %}
                </select>`;
                $row.find('td:eq(5)').html(selectArea);
            }

            if (!$row.find('.select-cargo').length) {
                let selectCargo = `<select class="select-cargo select2">
                    {% for c in cargos %}
                        <option value="{{ c|escape }}">{{ c }}</option>
                    {% endfor %}
                </select>`;
                $row.find('td:eq(6)').html(selectCargo);
            }

            // Asignar el valor actual
            $row.find('.select-centro').val(data.centro);
            $row.find('.select-area').val(data.area);
            $row.find('.select-cargo').val(data.cargo);

            // Activar select2
            $row.find('.select2').select2({
                width: '100%',
                dropdownAutoWidth: true,
                placeholder: 'Seleccionar...',
                allowClear: true
            });

            // Actualizar los datos del DataTable cuando cambie
            $row.find('select').on('change', function() {
                let updatedData = table.row($row).data();
                updatedData.centro = $row.find('.select-centro').val();
                updatedData.area = $row.find('.select-area').val();
                updatedData.cargo = $row.find('.select-cargo').val();
                table.row($row).data(updatedData).invalidate().draw(false);
            });
        });
    });
    // duplicar fila 
    $('#tempTable').on('click', '.duplicarFila', function() {
        let row = table.row($(this).parents('tr'));
        let rowData = row.data();
        let currentIndex = row.index();

        // clonar datos
        let newRow = { ...rowData };

        // reiniciar meses
        let meses = ["enero","febrero","marzo","abril","mayo","junio",
                    "julio","agosto","septiembre","octubre","noviembre","diciembre"];
        meses.forEach(m => newRow[m] = 0);

        // total en 0
        newRow.total = 0;

        // guardar posici√≥n de scroll actual del navegador
        const scrollY = window.scrollY;

        // üîπ obtener todos los datos actuales de la tabla
        let allData = table.rows().data().toArray();

        // üîπ insertar justo despu√©s del √≠ndice actual
        allData.splice(currentIndex + 1, 0, newRow);

        table.clear().rows.add(allData).draw(false);

        // restaurar posici√≥n exacta del scroll
        window.scrollTo(0, scrollY);

        // marcar y animar la nueva fila
        setTimeout(() => {
            let $newRowNode = $('#tempTable tbody tr').eq(currentIndex + 1);
            seleccionarFila($newRowNode);
            $newRowNode.addClass("blink");
            setTimeout(() => $newRowNode.removeClass("blink"), 2000);
        }, 50);

        showToast("Fila duplicada üìë", "success");
    });

    // ‚úÖ Checkbox maestro para seleccionar/deseleccionar todos
    $('#checkAllIPC').on('change', function() {
        let checked = $(this).is(':checked');
        $('.row-check').prop('checked', checked);
    });
    // ‚úÖ Si se desmarca una sola fila ‚Üí se desmarca el "Seleccionar todo"
    $('#tempTable').on('change', '.row-check', function() {
        if (!$(this).is(':checked')) {
            $('#checkAllIPC').prop('checked', false);
        } else if ($('.row-check:checked').length === $('.row-check').length) {
            $('#checkAllIPC').prop('checked', true);
        }
    });

    // funci√≥n para recalcular total de una fila
    function recalcularTotal(rowData) {
        let meses = ["enero","febrero","marzo","abril","mayo","junio",
                    "julio","agosto","septiembre","octubre","noviembre","diciembre"];
        let total = 0;
        meses.forEach(m => {
            total += parseFloat(rowData[m]) || 0;
        });
        rowData.total = total;
        return rowData;
    }
    // cerrar edici√≥n y guardar valor
    function cerrarEdicion(cell, newValue) {
        let row = table.row($(cell).closest("tr"));
        let rowData = row.data();

        // actualizar la celda
        let colIdx = table.cell(cell).index().column;
        let colName = table.column(colIdx).dataSrc();

        rowData[colName] = newValue;

        // recalcular total din√°micamente
        rowData = recalcularTotal(rowData);

        row.data(rowData).draw(false);
        editingCell = null;
    }

    let editingCell = null;
    // doble clic para editar
    $('#tempTable').on('dblclick', 'td.editable', function() {
        let cell = table.cell(this);
        let oldValue = cell.data();

        // üî• Si ya hay otra celda edit√°ndose, cerrarla primero
        if (editingCell && editingCell !== this) {
            let $prevInput = $(editingCell).find("input");
            if ($prevInput.length) {
                cerrarEdicion(editingCell, $prevInput.val());
            }
        }

        // Si la misma celda est√° en edici√≥n, no volver a abrir
        if (editingCell === this) return;

        $(this).html('<input type="text" class="cell-input" value="'+ oldValue +'"/>');
        let $input = $(this).find("input");
        let $cell = $(this);

        // üîπ Funci√≥n para ajustar el ancho del input seg√∫n su texto
        function ajustarAncho() {
            let tempSpan = $('<span>').text($input.val() || '')
                .css({
                    visibility: 'hidden',
                    position: 'absolute',
                    whiteSpace: 'pre',
                    font: $input.css('font')
                })
                .appendTo('body');

            let textWidth = tempSpan.width() + 12; // padding adicional
            tempSpan.remove();
            $input.width(textWidth);
        }

        // Inicializar tama√±o al abrir
        ajustarAncho();
        $input.focus();

        // üîπ Actualizar ancho mientras escribe
        $input.on('input', ajustarAncho);
        editingCell = this;

        // seleccionar todo el contenido
        $input[0].setSelectionRange(0, $input.val().length);

        // manejar Enter, Escape y flechas
        $input.on("keydown", function(e) {
            if (e.key === "Enter") {
                cerrarEdicion(editingCell, $input.val());
            } else if (e.key === "Escape") {
                table.cell(editingCell).data(oldValue).draw(false);
                editingCell = null;
            } else if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
                e.preventDefault();
                let $td = $(editingCell);
                let $tr = $td.closest("tr");
                let rowIdx = $tr.index();
                let colIdx = $td.index();

                if (e.key === "ArrowUp") rowIdx--;
                if (e.key === "ArrowDown") rowIdx++;
                if (e.key === "ArrowLeft") colIdx--;
                if (e.key === "ArrowRight") colIdx++;

                let $target = $('#tempTable tbody tr').eq(rowIdx).find("td").eq(colIdx);
                if ($target.length && $target.hasClass("editable")) {
                    // guardar antes de mover
                    cerrarEdicion(editingCell, $input.val());
                    $target.dblclick();
                }
            }
        });
    });
    // üî• Guardar al hacer clic fuera de la tabla
    $(document).on("click", function(e) {
        if (editingCell) {
            let $cell = $(editingCell);
            let $input = $cell.find("input");
            if ($input.length && !$(e.target).closest("#tempTable").length) {
                cerrarEdicion(editingCell, $input.val());
            }
        }
    });

    $('#subirPresupuestoForm').on('submit', function(e) {
        e.preventDefault(); // Evita el submit normal

        let $btn = $("#subirBtn");
        let $spinner = $btn.find(".spinner");

        // Mostrar spinner y deshabilitar bot√≥n
        $spinner.show();
        $btn.prop("disabled", true);

        $.post("{% url 'subir_presupuesto_sueldos' %}", {
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
        }, function(response) {
            if (response.success) {
                showToast(response.msg, "success");
            } else {
                showToast(response.msg, "error");
            }
        })
        .fail(function() {
            showToast("Error en la subida ‚ùå", "error");
        })
        .always(function() {
            // Ocultar spinner y reactivar bot√≥n
            $spinner.hide();
            $btn.prop("disabled", false);
        });
    });

    // agregar fila vac√≠a
    $('#agregarFila').on('click', function() {
        table.row.add({
            cedula: "", nombre: "", centro: "", area: "", cargo: "", concepto: "",
            salario_base: 0, enero: 0, febrero: 0, marzo: 0, abril: 0, mayo: 0, junio: 0,
            julio: 0, agosto: 0, septiembre: 0, octubre: 0, noviembre: 0, diciembre: 0,
            total: 0
        }).draw();
        showToast("Fila agregada ‚úÖ", "success");
    });

    // eliminar fila
    $('#tempTable').on('click', '.eliminarFila', function() {
        table.row($(this).parents('tr')).remove().draw();
        showToast("Fila eliminada ‚ùå", "error");
    });

    // Cargar datos base
    $('#cargarBase').on('click', function() {
        let $btn = $(this);
        let $spinner = $btn.find(".spinner");

        // Mostrar spinner y deshabilitar bot√≥n
        $spinner.show();
        $btn.prop("disabled", true);

        $.get("{% url 'cargar_nomina_base' %}", function() {
            table.ajax.reload();
            showToast("Datos cargados desde Conceptos (NOM516) üìÇ", "success");
        })
        .fail(function() {
            showToast("Error al cargar datos ‚ùå", "error");
        })
        .always(function() {
            // Ocultar spinner y reactivar bot√≥n
            $spinner.hide();
            $btn.prop("disabled", false);
        });
    });

    $('#calcularBtn').on('click', function() {
        calcular();
    });
        
    // Calcular solo las filas seleccionadas
    function calcular() {
        // üîπ Obtener incrementoSalarial y salarioMinimo desde el contexto Django
        const incrementoSalarial = parseFloat("{{ incrementoSalarial }}".replace(",", "."));
        const salarioMinimo = parseFloat("{{ salarioMinimo }}".replace(",", "."));

        // üîπ Iterar solo sobre filas seleccionadas (checkbox marcados)
        $('#tempTable tbody tr').each(function() {
            let $row = $(this);
            let $checkbox = $row.find('.row-check');

            if ($checkbox.is(':checked')) {
                // üîπ Obtener objeto de datos de la fila desde DataTables
                let row = table.row($row);
                let data = row.data();
                let salario = parseFloat(data.salario_base) || 0;

                if (salario > 0) {
                    let nuevoSalario = salario + (salario * incrementoSalarial / 100);
                    let auxRetro = (nuevoSalario - salario) * 2;
                    let retro = nuevoSalario + auxRetro;
                    let minimoIncremento = salarioMinimo + (salarioMinimo * incrementoSalarial / 100);

                    if (salario < minimoIncremento) {
                        auxRetro = (nuevoSalario - minimoIncremento) * 2;
                        retro = nuevoSalario + auxRetro;
                        data.enero = minimoIncremento;
                        data.febrero = minimoIncremento;
                        data.marzo = Math.round(retro); // retroactivo
                        data.abril = Math.round(nuevoSalario);
                        data.mayo = Math.round(nuevoSalario);
                        data.junio = Math.round(nuevoSalario);
                        data.julio = Math.round(nuevoSalario);
                        data.agosto = Math.round(nuevoSalario);
                        data.septiembre = Math.round(nuevoSalario);
                        data.octubre = Math.round(nuevoSalario);
                        data.noviembre = Math.round(nuevoSalario);
                        data.diciembre = Math.round(nuevoSalario);
                    } else {
                        data.enero = salario;
                        data.febrero = salario;
                        data.marzo = Math.round(retro); // retroactivo
                        data.abril = Math.round(nuevoSalario);
                        data.mayo = Math.round(nuevoSalario);
                        data.junio = Math.round(nuevoSalario);
                        data.julio = Math.round(nuevoSalario);
                        data.agosto = Math.round(nuevoSalario);
                        data.septiembre = Math.round(nuevoSalario);
                        data.octubre = Math.round(nuevoSalario);
                        data.noviembre = Math.round(nuevoSalario);
                        data.diciembre = Math.round(nuevoSalario);
                    }

                    // üîπ Calcular total
                    data.total = data.enero + data.febrero + data.marzo + data.abril +
                                data.mayo + data.junio + data.julio + data.agosto +
                                data.septiembre + data.octubre + data.noviembre + data.diciembre;

                    // üîπ Actualizar fila en DataTable
                    row.data(data).draw(false);
                }
            }
        });

        showToast("C√°lculo aplicado a filas seleccionadas ‚úÖ", "success");
    }


    // Configurar CSRF para AJAX
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute("content");
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type))) {
                xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
            }
        }
    });

    // Guardar en BD temporal
    $('#guardarTempBtn').on('click', function() {
        let $btn = $(this);
        let $spinner = $btn.find('.spinner');
        let data = table.rows().data().toArray();

        // Mostrar spinner
        $spinner.show();
        $btn.prop("disabled", true);

        $.ajax({
            url: "{% url 'guardar_nomina_temp' %}",
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function() {
                showToast("Datos guardados en tabla temporal ‚úÖ", "success");
            },
            error: function() {
                showToast("Error al guardar ‚ùå", "error");
            },
            complete: function() {
                // Ocultar spinner y reactivar bot√≥n
                $spinner.hide();
                $btn.prop("disabled", false);
            }
        });
    });

    function showToast(message, type = "success", duration = 3000) {
        let container = document.getElementById("toastContainer");
        let toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => toast.classList.add("show"), 50);

        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 500);
        }, duration);
    }
    
});
</script>
<!-- DataTables Buttons JS -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>
